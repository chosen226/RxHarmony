<!DOCTYPE html>
<html lang="en">
{% extends 'base.html' %} {% load static %} {% block title %}Profile -
RxHarmony{% endblock %}{% block content %} 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthcare Profile</title>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<style>
    /* Tabular Medications Styles */

.medications-table-container {
    overflow-x: auto;
    width: 100%;
}

.medications-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1rem;
}

.medications-table th,
.medications-table td {
    padding: 12px 10px;
    text-align: left;
    border-bottom: 1px solid var(--medium-gray);
}

.medications-table th {
    background-color: var(--light-gray);
    font-weight: 600;
    color: var(--text-color);
}

.medications-table tr:hover {
    background-color: rgba(53, 152, 219, 0.05);
}

.medications-table .medication-row-editing {
    background-color: rgba(53, 152, 219, 0.1);
}

.medications-table .medication-row-new {
    background-color: rgba(46, 204, 113, 0.1);
}

.medication-actions {
    display: flex;
    gap: 5px;
}
/* Grid layouts for profile sections */
.profile-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin-bottom: 20px;
}

.health-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 30px;
}

.health-section h3 {
    color: var(--primary-color);
    margin-bottom: 15px;
    font-size: 1.1rem;
}

.allergies-section, .conditions-section {
    display: flex;
    flex-direction: column;
}

.allergies-section textarea {
    min-height: 150px;
    flex-grow: 1;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .profile-grid, .health-grid {
        grid-template-columns: 1fr;
    }
}
.medications-table input,
.medications-table textarea,
.medications-table select {
    width: 100%;
    padding: 8px;
    border: 1px solid var(--medium-gray);
    border-radius: 4px;
    font-size: 0.9rem;
}

.medications-table textarea {
    min-height: 60px;
    resize: vertical;
}

.tablets-low {
    color: var(--danger-color);
}

.refill-warning {
    color: var(--warning-color);
    font-weight: bold;
}

.medication-view-mode,
.medication-edit-mode {
    width: 100%;
}

.medication-edit-mode {
    display: none;
}

.medication-row-editing .medication-view-mode {
    display: none;
}

.medication-row-editing .medication-edit-mode {
    display: block;
}

.medication-row-new .medication-view-mode {
    display: none;
}

.medication-row-new .medication-edit-mode {
    display: block;
}

/* Responsive adjustments for small screens */
@media (max-width: 768px) {
    .medications-table {
        min-width: 750px; /* Force horizontal scrolling on small screens */
    }
}
    /* Global styles */
:root {
    --primary-color: black;
    --primary-dark: black;
    --secondary-color: #e74c3c;
    --text-color: #333;
    --light-gray: #fbf8f8;
    --medium-gray: #ddd;
    --dark-gray: #fff;
    --success-color: #2ecc71;
    --warning-color: #f39c12;
    --danger-color: #e74c3c;
    --card-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.6;
    color: var(--text-color);
    background-color: var(--light-gray);
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

/* Header and Navigation */
header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--medium-gray);
    flex-wrap: wrap;
}

header h1 {
    color: var(--primary-color);
    margin-right: 2rem;
}

nav ul {
    display: flex;
    list-style: none;
    flex-wrap: wrap;
}

nav ul li {
    margin-right: 10px;
}

nav ul li a, nav ul li button {
    text-decoration: none;
    color: var(--dark-gray);
    padding: 8px 15px;
    border-radius: 4px;
    font-weight: 500;
    transition: all 0.3s ease;
    display: inline-block;
}

nav ul li a.active {
    color: var(--primary-color);
    font-weight: bold;
}

nav ul li a:hover {
    color: var(--primary-color);
}

#logoutBtn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1rem;
    font-family: inherit;
    color: var(--secondary-color);
}

#logoutBtn:hover {
    text-decoration: underline;
}

/* Cards and Sections */
.card {
    background-color: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: var(--card-shadow);
}

section {
    margin-bottom: 2rem;
}

section h2 {
    margin-bottom: 1rem;
    color: black
}

/* Forms */
.form-group {
    margin-bottom: 15px;
}

label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
}

input, select, textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--medium-gray);
    border-radius: 4px;
    font-family: inherit;
    font-size: 1rem;
}

textarea {
    min-height: 100px;
    resize: vertical;
}

/* Buttons */
.btn {
    display: inline-block;
    padding: 10px 15px;
    background-color: var(--primary-color);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
    transition: background-color 0.3s ease;
}

.btn-primary {
    background-color: var(--primary-color);
}

.btn-primary:hover {
    background-color: var(--primary-dark);
}

.btn-secondary {
    background-color: var(--dark-gray);
}

.btn-secondary:hover {
    background-color: #777;
}

.btn-danger {
    background-color: var(--danger-color);
}

.btn-danger:hover {
    background-color: #c0392b;
}

.btn-sm {
    padding: 5px 10px;
    font-size: 0.9rem;
}

/* Tabs */
.dashboard-tabs {
    display: flex;
    margin-bottom: 20px;
    border-bottom: 1px solid var(--medium-gray);
}

.tab-btn {
    background: none;
    border: none;
    padding: 10px 20px;
    font-size: 1rem;
    font-weight: 500;
    color: var(--dark-gray);
    cursor: pointer;
    border-bottom: 3px solid transparent;
}

.tab-btn.active {
    color: var(--primary-color);
    border-bottom: 3px solid var(--primary-color);
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

/* Medication Dashboard */
.action-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.medication-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
}

.medication-card {
    background-color: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: var(--card-shadow);
    position: relative;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.medication-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.medication-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 15px;
}

.medication-name {
    font-weight: bold;
    color: var(--primary-dark);
    font-size: 1.2rem;
    margin-bottom: 5px;
}

.medication-desc {
    color: var(--dark-gray);
    margin-bottom: 10px;
    font-size: 0.9rem;
}

.medication-info {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 10px;
}

.medication-info span {
    background-color: var(--light-gray);
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.85rem;
}

.refill-warning {
    color: var(--warning-color);
    font-weight: bold;
}

.tablets-low {
    color: var(--danger-color);
}

/* Tracking Section */
.tracking-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.date-navigation {
    display: flex;
    align-items: center;
    gap: 10px;
}

.tracking-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.tracking-item {
    background-color: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: var(--card-shadow);
}

.tracking-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.tracking-doses {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
}

.dose-checkbox {
    display: flex;
    align-items: center;
    gap: 5px;
}

.dose-checkbox input {
    width: auto;
}

.dose-time {
    font-size: 0.9rem;
    color: var(--dark-gray);
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: white;
    margin: 10% auto;
    padding: 20px;
    border-radius: 8px;
    width: 80%;
    max-width: 600px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    position: relative;
}

.close {
    position: absolute;
    top: 10px;
    right: 15px;
    font-size: 24px;
    cursor: pointer;
    color: var(--dark-gray);
}

/* Messages */
.message-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
}

.message {
    padding: 12px 20px;
    margin-bottom: 10px;
    border-radius: 4px;
    color: white;
    background-color: var(--primary-color);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    animation: slideIn 0.3s ease-out;
}

.message.success {
    background-color: var(--success-color);
}

.message.error {
    background-color: var(--danger-color);
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Empty states */
.empty-state {
    text-align: center;
    padding: 40px;
    color: var(--dark-gray);
    font-style: italic;
}

/* Medical Conditions */
.condition-list ul {
    list-style: none;
    margin-bottom: 15px;
}

.condition-list li {
    padding: 8px 10px;
    background-color: var(--light-gray);
    margin-bottom: 5px;
    border-radius: 4px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.add-condition {
    display: flex;
    gap: 10px;
}

.add-condition input {
    flex: 1;
}

/* Responsive styles */
@media (max-width: 768px) {
    header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    header h1 {
        margin-bottom: 1rem;
    }
    
    nav ul {
        flex-direction: column;
        width: 100%;
    }
    
    nav ul li {
        margin-bottom: 5px;
        width: 100%;
    }
    
    nav ul li a, nav ul li button {
        width: 100%;
        text-align: center;
    }
    
    .medication-list {
        grid-template-columns: 1fr;
    }
    
    .tracking-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .modal-content {
        width: 95%;
        margin: 5% auto;
    }
}
/* Health Information Styling */
.health-info-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.allergies-section h3,
.conditions-section h3 {
    color: var(--text-color);
    margin-bottom: 10px;
    font-size: 1rem;
    font-weight: 600;
}



.editable-field {
    position: relative;
    display: flex;
    align-items: flex-start;
}

.save-btn {
    position: absolute;
    right: 5px;
    top: 5px;
    background: none;
    border: none;
    cursor: pointer;
    color: var(--primary-color);
}

/* Conditions section */
.conditions-section ul {
    border: none;
    margin-bottom: 15px;
    padding: 0;
}

.conditions-section li {
    color: black;
    padding: 8px 0;
    border-bottom: 1px solid var(--light-gray);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.add-condition {
    display: flex;
    align-items: center;
    gap: 10px;
}

.add-condition input {
    flex: 1;
    padding: 8px;
    border: 1px solid var(--medium-gray);
    border-radius: 4px;
}



.btn-circle:hover {
    background-color: var(--primary-dark);
}
/* Health Information Styling */
.health-info-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.compact-width-container {
    width: 45%;
    max-width: 300px;
}

.allergies-section h3,
.conditions-section h3 {
    color: var(--text-color);
    margin-bottom: 10px;
    font-size: 1rem;
    font-weight: 600;
}

/* Allergies section */
.allergies-section textarea,
#allergies {
    width: 100%;
    height: 38px !important; /* Force a smaller height */
    min-height: unset !important; /* Override any min-height settings */
    resize: none;
    padding: 4px 8px; /* Reduce padding to make it look smaller */
    border: 1px solid var(--medium-gray);
    border-radius: 4px;
    overflow-y: hidden; /* Hide vertical scrollbar */
    line-height: 1.2; /* Reduce line height */
    font-size: 0.9rem; /* Slightly smaller font */
}
.editable-field {
    position: relative;
    display: flex;
    align-items: flex-start;
}

.save-btn {
    position: absolute;
    right: 5px;
    top: 5px;
    background: none;
    border: none;
    cursor: pointer;
    color: var(--primary-color);
}

/* Conditions section */
.conditions-section ul {
    list-style: none;
    border: none;
    margin-bottom: 15px;
    padding: 0;
}

.conditions-section li {
    padding: 8px 0;
    border-bottom: 1px solid var(--light-gray);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.add-condition {
    display: flex;
    align-items: center;
    gap: 10px;
}

.add-condition input {
    flex: 1;
    padding: 8px;
    border: 1px solid var(--medium-gray);
    border-radius: 4px;
}

.btn-circle {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--primary-color);
    color: white;
    font-size: 18px;
    border: none;
    cursor: pointer;
}

.btn-circle:hover {
    background-color: var(--primary-dark);
}
/* Updated Medication Management Styles */
.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.card-header h2 {
    margin: 0;
    color: #000;
    font-size: 1.4rem;
}

.btn-dark {
    background-color: #212529;
    color: white;
    border-radius: 4px;
    padding: 8px 16px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.btn-dark:hover {
    background-color: #343a40;
}

.plus-icon {
    font-weight: bold;
}

.medications-table {
    width: 100%;
    border-collapse: collapse;
}

.medications-table th,
.medications-table td {
    padding: 12px 16px;
    text-align: left;
    border-bottom: 1px solid #dee2e6;
}

.medications-table th {
    font-weight: 500;
    color: #212529;
    background-color: transparent;
    border-top: 1px solid #dee2e6;
}

.medications-table tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.02);
}

/* Medication row styles */
.medication-dose {
    display: block;
    font-size: 0.85rem;
    color: #6c757d;
    margin-top: 3px;
}

/* Action icons */
.action-icons {
    display: flex;
    gap: 12px;
}

.action-icon {
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    color: #6c757d;
    font-size: 1.1rem;
}

.edit-icon {
    color: #0d6efd;
}

.delete-icon {
    color: #dc3545;
}
/* Add these CSS rules if they're not already in your stylesheet */
.medication-edit-mode {
    display: none;
}

.medication-row-editing .medication-view-mode {
    display: none;
}

.medication-row-editing .medication-edit-mode {
    display: block;
}
.conditions-section li {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.delete-condition {
  padding: 2px 5px;
  margin-left: 10px;
  background-color: transparent;
  color: #dc3545;
  border: none;
  cursor: pointer;
  font-size: 1rem;
}

.delete-condition:hover {
  color: #c82333;
}
</style>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthcare Profile</title>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <div class="container">
       

        <main>
            
            <section class="profile-section">
    
    <div class="card">
        <h2>Personal Information</h2>
        <form id="profileForm">
            <div class="profile-grid">
                <div class="form-group">
                    <label for="date_of_birth">Date of Birth:</label>
                    <input type="date" id="date_of_birth" name="date_of_birth" value="{{ profile.date_of_birth|date:'Y-m-d' }}">
                </div>
                <div class="form-group">
                    <label for="gender">Gender:</label>
                    <select id="gender" name="gender">
                        <option value="" {% if not profile.gender %}selected{% endif %}>Select Gender</option>
                        <option value="M" {% if profile.gender == 'M' %}selected{% endif %}>Male</option>
                        <option value="F" {% if profile.gender == 'F' %}selected{% endif %}>Female</option>
                        <option value="O" {% if profile.gender == 'O' %}selected{% endif %}>Other</option>
                        <option value="N" {% if profile.gender == 'N' %}selected{% endif %}>Prefer not to say</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="blood_type">Blood Type:</label>
                    <select id="blood_type" name="blood_type">
                        <option value="" {% if not profile.blood_type %}selected{% endif %}>Select Blood Type</option>
                        <option value="A+" {% if profile.blood_type == 'A+' %}selected{% endif %}>A+</option>
                        <option value="A-" {% if profile.blood_type == 'A-' %}selected{% endif %}>A-</option>
                        <option value="B+" {% if profile.blood_type == 'B+' %}selected{% endif %}>B+</option>
                        <option value="B-" {% if profile.blood_type == 'B-' %}selected{% endif %}>B-</option>
                        <option value="AB+" {% if profile.blood_type == 'AB+' %}selected{% endif %}>AB+</option>
                        <option value="AB-" {% if profile.blood_type == 'AB-' %}selected{% endif %}>AB-</option>
                        <option value="O+" {% if profile.blood_type == 'O+' %}selected{% endif %}>O+</option>
                        <option value="O-" {% if profile.blood_type == 'O-' %}selected{% endif %}>O-</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="emergency_contact">Emergency Contact:</label>
                    <input type="text" id="emergency_contact" name="emergency_contact" value="{{ profile.emergency_contact }}">
                </div>
                <div class="form-group">
                    <label for="emergency_contact_phone">Emergency Contact Phone:</label>
                    <input type="tel" id="emergency_contact_phone" name="emergency_contact_phone" value="{{ profile.emergency_contact_phone }}">
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Save Changes</button>
        </form>
    </div>
</section>
<section class="health-section">
   
    <div class="card">
         <h2>Health Information</h2>
        <div class="health-info-container">
            <div class="allergies-section">
                <h3>Allergies</h3>
                <div class="compact-width-container">
                    <div class="editable-field">
                        <textarea id="allergies" name="allergies" form="profileForm">{{ profile.allergies }}</textarea>
                        <button id="saveAllergies" class="btn-sm save-btn" style="display: none;"><i class="save-icon">💾</i></button>
                    </div>
                </div>
            </div>
            
            <div class="conditions-section">
                <h3>Medical Conditions</h3>
                <ul id="conditionsList">
                    {% for condition in conditions %}
                        <li>
                            {{ condition.name }}
                            <button class="btn-sm btn-danger delete-condition" data-id="{{ condition.id }}">🗑️</button>
                        </li>
                    {% empty %}
                        <li class="empty-state">No medical conditions added.</li>
                    {% endfor %}
                </ul>
                <div class="compact-width-container">
                    <div class="add-condition">
                        <input type="text" id="newCondition" placeholder="Add a condition...">
                        <button id="addCondition" class="btn-sm btn-circle"><i class="plus-icon">+</i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
          <section class="medications-section">
    <div class="card">
        <div class="card-header">
            <h2>Medication Management</h2>
            <button id="addMedicationBtn" class="btn btn-dark">
                <i class="plus-icon">+</i> Add Medication
            </button>
        </div>
        <div class="medications-table-container">
            <table class="medications-table" id="medicationsTable">
                <thead>
                    <tr>
                        <th>Medication</th>
                        <th>Directions</th>
                        <th>Dosage</th>
                        <th>Remaining Tablets</th>
                        <th>Refill Due</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="medicationTableBody">
                    <!-- Medications will be inserted here -->
                </tbody>
            </table>
            <div id="emptyMedicationState" class="empty-state">You don't have any medications added yet.</div>
        </div>
    </div>
</section>
            
        </main>

        <!-- Add/Edit Medication Modal -->
        <div class="modal" id="medicationModal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2 id="modalTitle">Add Medication</h2>
                <form id="medicationForm">
                    <input type="hidden" id="medicationId">
                    <div class="form-group">
                        <label for="medName">Medication Name:</label>
                        <input type="text" id="medName" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="medDescription">Description:</label>
                        <textarea id="medDescription" name="description"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="medFrequency">Times per Day:</label>
                        <input type="number" id="medFrequency" name="frequency_per_day" min="1" value="1" required>
                    </div>
                    <div class="form-group">
                        <label for="medDosage">Tablets per Dose:</label>
                        <input type="number" id="medDosage" name="tablets_per_dose" min="0.5" step="0.5" value="1" required>
                    </div>
                    <div class="form-group">
                        <label for="medRemaining">Remaining Tablets:</label>
                        <input type="number" id="medRemaining" name="remaining_tablets" min="0" step="0.5" value="30" required>
                    </div>
                    <div class="form-group">
                        <label for="medRefillDate">Refill Date (optional):</label>
                        <input type="date" id="medRefillDate" name="refill_date">
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">Save</button>
                        <button type="button" class="btn btn-secondary" id="cancelMedication">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="messageContainer" class="message-container"></div>
    </div>

  <script>
   // Global variables
let globalConditions = [];

// Utility functions
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showMessage(message, type = 'info') {
    const messageContainer = document.getElementById('messageContainer');
    const messageElement = document.createElement('div');
    messageElement.classList.add('message');
    messageElement.classList.add(type);
    messageElement.textContent = message;
    
    messageContainer.appendChild(messageElement);
    
    // Remove message after 4 seconds
    setTimeout(() => {
        messageElement.remove();
    }, 4000);
}

function saveProfileData() {
    console.log("Saving profile data");
    
    // Get current form data
    const profileForm = document.getElementById('profileForm');
    const formData = new FormData(profileForm);
    const profileData = {
        date_of_birth: formData.get('date_of_birth'),
        gender: formData.get('gender'),
        blood_type: formData.get('blood_type'),
        allergies: formData.get('allergies'),
        emergency_contact: formData.get('emergency_contact'),
        emergency_contact_phone: formData.get('emergency_contact_phone'),
        conditions: globalConditions
    };
    
    console.log("Saving profile data:", profileData);
    
    // Use the profile update endpoint
    fetch('/api/profile/update/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(profileData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok: ' + response.status);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showMessage('Profile updated successfully', 'success');
        } else {
            showMessage('Error: ' + (data.message || data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Error updating profile:', error);
        showMessage('Error updating profile: ' + error.message, 'error');
        
        // If there's a 404 error, fall back to the old endpoint
        if (error.message.includes('404')) {
            console.log("Falling back to legacy profile update endpoint");
            // Try the old endpoint as fallback
            fetch('/profile/setup/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(profileData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Legacy endpoint failed: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                showMessage('Profile updated successfully (legacy method)', 'success');
                // Reload medications since we used the legacy endpoint which might affect them
                setTimeout(() => {
                    loadMedications();
                }, 500);
            })
            .catch(fallbackError => {
                console.error('Error with legacy profile update:', fallbackError);
                showMessage('Could not update profile with either method', 'error');
            });
        }
    });
}

// Main document ready handler - all initialization here
document.addEventListener('DOMContentLoaded', function() {
    // DOM Elements
    const profileForm = document.getElementById('profileForm');
    const conditionsList = document.getElementById('conditionsList');
    const newConditionInput = document.getElementById('newCondition');
    const addConditionBtn = document.getElementById('addCondition');
    const logoutBtn = document.getElementById('logoutBtn');
    const medicationList = document.getElementById('medicationList');
    const medicationTableBody = document.getElementById('medicationTableBody');
    const addMedicationBtn = document.getElementById('addMedicationBtn');
    const emptyMedicationState = document.getElementById('emptyMedicationState');
    const medicationModal = document.getElementById('medicationModal');
    const modalClose = document.querySelector('.close');
    const cancelMedicationBtn = document.getElementById('cancelMedication');
    const medicationForm = document.getElementById('medicationForm');
    const modalTitle = document.getElementById('modalTitle');
    const allergiesTextarea = document.getElementById('allergies');
    const saveAllergiesBtn = document.getElementById('saveAllergies');
    
    // Load initial conditions from the DOM
    loadConditions();
    
    // Load medications, profile data, and setup handlers
    loadMedications();
    loadProfileData();
    setupMedicationHandlers();
    
    // Document-level click handler for condition deletion
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('delete-condition')) {
            event.preventDefault();
            event.stopPropagation();
            
            console.log("Delete condition button clicked");
            
            const deleteBtn = event.target;
            const li = deleteBtn.closest('li');
            const conditionName = li.textContent.replace('Remove', '').trim();
            
            console.log("Removing condition:", conditionName);
            console.log("Current conditions:", globalConditions);
            
            // Remove this condition from the UI
            li.remove();
            
            // Remove from global tracking array
            const index = globalConditions.indexOf(conditionName);
            if (index > -1) {
                globalConditions.splice(index, 1);
                console.log("Condition removed from array, new conditions:", globalConditions);
            }
            
            // Save the profile with the updated conditions
            saveProfileData();
            
            // Show empty state if no conditions left
            if (conditionsList.children.length === 0) {
                const emptyLi = document.createElement('li');
                emptyLi.classList.add('empty-state');
                emptyLi.textContent = 'No medical conditions added.';
                conditionsList.appendChild(emptyLi);
            }
        }
    });
    
    // Add new condition button
    addConditionBtn.addEventListener('click', function() {
        const conditionName = newConditionInput.value.trim();
        
        if (!conditionName) {
            showMessage('Please enter a condition name', 'error');
            return;
        }
        
        // Check if condition already exists
        if (globalConditions.includes(conditionName)) {
            showMessage('This condition already exists', 'error');
            return;
        }
        
        // Add to the UI and tracking array
        addConditionToList(conditionName);
        globalConditions.push(conditionName);
        
        // Clear input
        newConditionInput.value = '';
        
        // Save the updated profile with the new condition
        saveProfileData();
    });
    
    // Also add condition when pressing Enter in input
    newConditionInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            addConditionBtn.click();
        }
    });
    
    // Handle profile form submission
    profileForm.addEventListener('submit', function(e) {
        e.preventDefault();
        saveProfileData();
    });
    
    // Add new medication button click
    addMedicationBtn.addEventListener('click', function() {
        // Create a new row for adding medication
        const newRow = createNewMedicationRow();
        medicationTableBody.appendChild(newRow);
        
        // Hide empty state if visible
        emptyMedicationState.style.display = 'none';
        
        // Focus on the name field
        newRow.querySelector('input[name="name"]').focus();
    });
    
    // Show save button when allergies are edited
    allergiesTextarea.addEventListener('input', function() {
        saveAllergiesBtn.style.display = 'block';
    });
    
    // Save allergies when save button is clicked
    saveAllergiesBtn.addEventListener('click', function() {
        saveProfileData();
        saveAllergiesBtn.style.display = 'none';
    });
    
    // Medication Modal functionality
    if (modalClose) {
        modalClose.addEventListener('click', function() {
            closeMedicationModal();
        });
    }
    
    if (cancelMedicationBtn) {
        cancelMedicationBtn.addEventListener('click', function() {
            closeMedicationModal();
        });
    }
    
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target === medicationModal) {
            closeMedicationModal();
        }
    });
    
    // Handle medication form submission
    if (medicationForm) {
        medicationForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const medicationId = document.getElementById('medicationId').value;
            const formData = new FormData(medicationForm);
            
            const medicationData = {
                name: formData.get('name'),
                description: formData.get('description'),
                frequency_per_day: parseInt(formData.get('frequency_per_day')),
                tablets_per_dose: parseFloat(formData.get('tablets_per_dose')),
                remaining_tablets: parseFloat(formData.get('remaining_tablets')),
                refill_date: formData.get('refill_date') || null
            };
            
            // Determine if it's an update or new medication
            const url = medicationId ? 
                `/api/medications/${medicationId}/` : 
                '/api/medications/';
            
            const method = medicationId ? 'PUT' : 'POST';
            
            // Save the medication
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(medicationData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                closeMedicationModal();
                showMessage(`Medication ${medicationId ? 'updated' : 'added'} successfully`, 'success');
                
                // Reload medication list
                loadMedications();
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage(`Error ${medicationId ? 'updating' : 'adding'} medication: ` + error.message, 'error');
            });
        });
    }
    
    // Logout functionality
    if (logoutBtn) {
        logoutBtn.addEventListener('click', function() {
            fetch('/logout/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = data.redirect_url;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Error logging out', 'error');
            });
        });
    }
    
    // Function definitions within document.ready
    
    // Load current conditions from the page
    function loadConditions() {
        globalConditions = [];
        
        // Get conditions from the rendered list items
        const liElements = conditionsList.querySelectorAll('li:not(.empty-state)');
        liElements.forEach(li => {
            // Only get the text content, not including the button text
            const buttonText = li.querySelector('button') ? li.querySelector('button').textContent : '';
            const conditionText = li.textContent.replace(buttonText, '').trim();
            
            if (conditionText) {
                globalConditions.push(conditionText);
            }
        });
        
        console.log("Loaded conditions:", globalConditions);
    }
    
    // Function to add a condition to the list
    function addConditionToList(conditionName) {
        if (!conditionName) return;
        
        // Remove empty state if present
        const emptyState = conditionsList.querySelector('.empty-state');
        if (emptyState) {
            emptyState.remove();
        }
        
        // Add to the UI
        const li = document.createElement('li');
        li.textContent = conditionName;
        
        // Add delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.classList.add('btn-sm', 'btn-danger', 'delete-condition');
        deleteBtn.textContent = 'Remove';
        
        li.appendChild(deleteBtn);
        conditionsList.appendChild(li);
    }
    
    // Function to load profile data from the API
    function loadProfileData() {
        // Try to fetch profile data from API
        fetch('/api/profile/')
            .then(response => {
                if (!response.ok) {
                    if (response.status === 404) {
                        console.log("Profile API endpoint not found. Using DOM values.");
                        return Promise.reject("API endpoint not found");
                    }
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // If API successful, update form with API data
                populateProfileForm(data);
                
                // If conditions are included in the API response, update them
                if (data.conditions && Array.isArray(data.conditions)) {
                    updateConditionsList(data.conditions);
                }
            })
            .catch(error => {
                // If API failed, ensure DOM values are properly loaded
                if (error === "API endpoint not found") {
                    // Just ensure the form is properly initialized with existing DOM values
                    checkFormInitialization();
                } else {
                    console.error('Error loading profile:', error);
                }
            });
    }
    
    // Function to update conditions list from API data
    function updateConditionsList(conditions) {
        // Clear existing conditions
        conditionsList.innerHTML = '';
        globalConditions = [];
        
        if (conditions.length > 0) {
            conditions.forEach(condition => {
                // Extract the condition name whether it's an object or string
                const conditionName = typeof condition === 'object' ? condition.name : condition;
                addConditionToList(conditionName);
                globalConditions.push(conditionName);
            });
        } else {
            // Show empty state if no conditions
            const emptyLi = document.createElement('li');
            emptyLi.classList.add('empty-state');
            emptyLi.textContent = 'No medical conditions added.';
            conditionsList.appendChild(emptyLi);
        }
    }
    
    // Function to populate profile form with data
    function populateProfileForm(data) {
        // Set each form field value from data if available
        if (data.date_of_birth) {
            document.getElementById('date_of_birth').value = data.date_of_birth.split('T')[0];
        }
        if (data.gender) {
            document.getElementById('gender').value = data.gender;
        }
        if (data.blood_type) {
            document.getElementById('blood_type').value = data.blood_type;
        }
        if (data.allergies) {
            document.getElementById('allergies').value = data.allergies;
        }
        if (data.emergency_contact) {
            document.getElementById('emergency_contact').value = data.emergency_contact;
        }
        if (data.emergency_contact_phone) {
            document.getElementById('emergency_contact_phone').value = data.emergency_contact_phone;
        }
    }
    
    // Function to check if form values are properly initialized from Django template
    function checkFormInitialization() {
        // For date inputs that may have format issues from Django template
        const dobInput = document.getElementById('date_of_birth');
        if (dobInput.value && dobInput.value.includes('/')) {
            // Convert potential MM/DD/YYYY format to YYYY-MM-DD for HTML5 date input
            const parts = dobInput.value.split('/');
            if (parts.length === 3) {
                const newDate = `${parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
                dobInput.value = newDate;
            }
        }
        
        // For select elements, ensure they have proper values selected
        const genderSelect = document.getElementById('gender');
        const bloodTypeSelect = document.getElementById('blood_type');
        
        // If these have values but no option is selected, try to select the option
        if (genderSelect.value && !genderSelect.selectedOptions[0]) {
            const genderOption = genderSelect.querySelector(`option[value="${genderSelect.value}"]`);
            if (genderOption) genderOption.selected = true;
        }
        
        if (bloodTypeSelect.value && !bloodTypeSelect.selectedOptions[0]) {
            const bloodOption = bloodTypeSelect.querySelector(`option[value="${bloodTypeSelect.value}"]`);
            if (bloodOption) bloodOption.selected = true;
        }
    }
    
    // Function to load medications from the API
    function loadMedications() {
        fetch('/api/medications/')
            .then(response => {
                if (!response.ok) {
                    if (response.status === 404) {
                        console.log("Medications API endpoint not found. Using DOM data instead.");
                        return Promise.reject("API endpoint not found");
                    }
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Clear current table
                medicationTableBody.innerHTML = '';
                
                if (data.medications && data.medications.length > 0) {
                    // Render each medication
                    data.medications.forEach(med => {
                        const row = createMedicationRow(med);
                        medicationTableBody.appendChild(row);
                    });
                    
                    // Hide empty state
                    emptyMedicationState.style.display = 'none';
                } else {
                    // Show empty state
                    emptyMedicationState.style.display = 'block';
                }
            })
            .catch(error => {
                // Only show this message if it's not our known "API endpoint not found" error
                if (error !== "API endpoint not found") {
                    console.error('Error loading medications:', error);
                    emptyMedicationState.textContent = 'Error loading medications. Please try again.';
                    emptyMedicationState.style.display = 'block';
                }
            });
    }
    
    // Function to create a medication row
    function createMedicationRow(medication) {
    console.log("Creating row for medication:", medication);
    
    try {
        // Create the row element
        const row = document.createElement('tr');
        row.classList.add('medication-row');
        
        // Safely set dataset ID
        if (medication.id) {
            row.dataset.id = medication.id;
        } else {
            console.warn("Medication is missing ID");
        }
        
        // Safely format directions
        let directions = "";
        try {
            directions = `${medication.frequency_per_day}x daily`;
        } catch (e) {
            console.error("Error formatting directions:", e);
            directions = "Unknown";
        }
        
        // Calculate refill due date based on usage
        let calculatedRefillDate = null;
        try {
            if (medication.remaining_tablets && medication.frequency_per_day && medication.tablets_per_dose) {
                const dailyUsage = medication.frequency_per_day * medication.tablets_per_dose;
                const daysRemaining = Math.floor(medication.remaining_tablets / dailyUsage);
                
                calculatedRefillDate = new Date();
                calculatedRefillDate.setDate(calculatedRefillDate.getDate() + daysRemaining);
            }
        } catch (e) {
            console.error("Error calculating refill date:", e);
        }
        
        // Use calculated date if available, otherwise use stored refill date
        let refillDateDisplay = "None";
        try {
            if (calculatedRefillDate) {
                refillDateDisplay = calculatedRefillDate.toLocaleDateString();
            } else if (medication.refill_date) {
                const refillDate = new Date(medication.refill_date);
                refillDateDisplay = refillDate.toLocaleDateString();
            }
        } catch (e) {
            console.error("Error formatting refill date:", e);
            refillDateDisplay = String(medication.refill_date || "None");
        }
        
        // Build row HTML
        try {
            row.innerHTML = `
                <td>
                    <div class="medication-view-mode">${medication.name || 'Unknown'}</div>
                    <div class="medication-edit-mode">
                        <input type="text" name="name" value="${medication.name || ''}" required>
                    </div>
                </td>
                <td>
                    <div class="medication-view-mode">${directions}</div>
                    <div class="medication-edit-mode">
                        <textarea name="description">${medication.description || ''}</textarea>
                        <input type="number" name="frequency_per_day" min="1" value="${medication.frequency_per_day || 1}" required>
                    </div>
                </td>
                <td>
                    <div class="medication-view-mode">${medication.tablets_per_dose || 1}</div>
                    <div class="medication-edit-mode">
                        <input type="number" name="tablets_per_dose" min="0.5" step="0.5" value="${medication.tablets_per_dose || 1}" required>
                    </div>
                </td>
                <td>
                    <div class="medication-view-mode">${medication.remaining_tablets || 0}</div>
                    <div class="medication-edit-mode">
                        <input type="number" name="remaining_tablets" min="0" step="0.5" value="${medication.remaining_tablets || 0}" required>
                    </div>
                </td>
                <td>
                    <div class="medication-view-mode">${refillDateDisplay}</div>
                    <div class="medication-edit-mode">
                        <input type="date" name="refill_date" value="${medication.refill_date ? medication.refill_date.split('T')[0] : ''}">
                    </div>
                </td>
                <td>
                    <div class="medication-view-mode action-icons">
                        <button class="action-icon refill-medication">🔄</button>
                        <button class="action-icon edit-medication">✏️</button>
                        <button class="action-icon delete-medication">🗑️</button>
                    </div>
                    <div class="medication-edit-mode action-icons">
                        <button class="btn btn-sm btn-primary save-medication">Save</button>
                        <button class="btn btn-sm cancel-edit">Cancel</button>
                    </div>
                </td>
            `;
        } catch (e) {
            console.error("Error setting innerHTML:", e);
            row.textContent = "Error creating medication row";
            return row;
        }
        
        // Try to add event listeners
        try {
            setupRowEventListeners(row);
        } catch (e) {
            console.error("Error setting up event listeners:", e);
        }
        
        return row;
    } catch (outerError) {
        console.error("Unexpected error in createMedicationRow:", outerError);
        const errorRow = document.createElement('tr');
        errorRow.innerHTML = '<td colspan="6">Error creating medication row</td>';
        return errorRow;
    }
}
    // Function to create a new empty medication row
   function createNewMedicationRow() {
    const row = document.createElement('tr');
    row.classList.add('medication-row', 'medication-row-new');
    
    row.innerHTML = `
        <td>
            <div class="medication-view-mode"></div>
            <div class="medication-edit-mode">
                <input type="text" name="name" placeholder="Medication name" required>
            </div>
        </td>
        <td>
            <div class="medication-view-mode"></div>
            <div class="medication-edit-mode">
                <textarea name="description" placeholder="Description"></textarea>
            </div>
        </td>
        <td>
            <div class="medication-view-mode"></div>
            <div class="medication-edit-mode">
                <p>Doses per day</p>
                <input type="number" name="frequency_per_day" min="1" value="1" required>
            </div>
        </td>
        <td>
            <div class="medication-view-mode"></div>
            <div class="medication-edit-mode">
                <p>Tablets per dose </p>
                <input type="number" name="tablets_per_dose" min="0.5" step="0.5" value="1" required>
            </div>
        </td>
        <td>
            <div class="medication-view-mode"></div>
            <div class="medication-edit-mode">
                <p>Remaining tablets</p>
                <input type="number" name="remaining_tablets" min="0" step="0.5" value="30" required>
            </div>
        </td>
        <td>
            <div class="medication-view-mode"></div>
            <div class="medication-edit-mode">
                <input type="hidden" name="refill_date" value="">
            </div>
        </td>
        <td>
            <div class="medication-view-mode medication-actions"></div>
            <div class="medication-edit-mode medication-actions">
                <button class="btn btn-sm btn-primary save-medication">Save</button>
                <button class="btn btn-sm cancel-edit">Cancel</button>
            </div>
        </td>
    `;
    
    // Setup listeners for save and cancel buttons
    const saveBtn = row.querySelector('.save-medication');
    const cancelBtn = row.querySelector('.cancel-edit');
    
    saveBtn.addEventListener('click', function() {
        saveMedication(row);
    });
    
    cancelBtn.addEventListener('click', function() {
        if (confirm('Discard this new medication?')) {
            row.remove();
            
            // Show empty state if no medications left
            if (medicationTableBody.children.length === 0) {
                emptyMedicationState.style.display = 'block';
            }
        }
    });
    
    return row;
}
    
    // Setup event listeners for a medication row
    function setupRowEventListeners(row) {
        const editBtn = row.querySelector('.edit-medication');
        const deleteBtn = row.querySelector('.delete-medication');
        const refillBtn = row.querySelector('.refill-medication');
        const saveBtn = row.querySelector('.save-medication');
        const cancelBtn = row.querySelector('.cancel-edit');
        
        // Store original values for cancel
        let originalValues = {};
        
        if (editBtn) {
            editBtn.addEventListener('click', function() {
                // Save original values before editing
                originalValues = {
                    name: row.querySelector('input[name="name"]').value,
                    description: row.querySelector('textarea[name="description"]').value,
                    frequency_per_day: row.querySelector('input[name="frequency_per_day"]').value,
                    tablets_per_dose: row.querySelector('input[name="tablets_per_dose"]').value,
                    remaining_tablets: row.querySelector('input[name="remaining_tablets"]').value,
                    refill_date: row.querySelector('input[name="refill_date"]').value
                };
                
                // Enable editing
                row.classList.add('medication-row-editing');
            });
        }
        
        if (cancelBtn) {
            cancelBtn.addEventListener('click', function() {
                // Restore original values
                if (Object.keys(originalValues).length > 0) {
                    row.querySelector('input[name="name"]').value = originalValues.name;
                    row.querySelector('textarea[name="description"]').value = originalValues.description;
                    row.querySelector('input[name="frequency_per_day"]').value = originalValues.frequency_per_day;
                    row.querySelector('input[name="tablets_per_dose"]').value = originalValues.tablets_per_dose;
                    row.querySelector('input[name="remaining_tablets"]').value = originalValues.remaining_tablets;
                    row.querySelector('input[name="refill_date"]').value = originalValues.refill_date;
                }
                
                // Disable editing
                row.classList.remove('medication-row-editing');
            });
        }
        
        if (deleteBtn) {
            deleteBtn.addEventListener('click', function() {
                const medicationId = row.dataset.id;
                const medicationName = row.querySelector('.medication-view-mode').textContent.trim();
                
                if (confirm(`Are you sure you want to delete ${medicationName}?`)) {
                    fetch(`/api/medications/${medicationId}/`, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        row.remove();
                        showMessage('Medication deleted successfully', 'success');
                        
                        // Show empty state if no medications left
                        if (medicationTableBody.children.length === 0) {
                            emptyMedicationState.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showMessage('Error deleting medication: ' + error.message, 'error');
                    });
                }
            });
        }
        
        if (refillBtn) {
            refillBtn.addEventListener('click', function() {
                const medicationId = row.dataset.id;
                
                fetch(`/api/medications/${medicationId}/refill/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    showMessage('Medication refilled successfully', 'success');
                    // Reload medications to show updated counts and dates
                    loadMedications();
                })
                .catch(error => {
                    console.error('Error:', error);
                    showMessage('Error refilling medication: ' + error.message, 'error');
                });
            });
        }
        
        if (saveBtn) {
            saveBtn.addEventListener('click', function() {
                saveMedication(row);
            });
        }
    }
    
    // Function to save medication data
    function saveMedication(row) {
        const isNewMedication = row.classList.contains('medication-row-new');
        const medicationId = isNewMedication ? null : row.dataset.id;
        
        // Collect data from form fields
        const medicationData = {
            name: row.querySelector('input[name="name"]').value,
            description: row.querySelector('textarea[name="description"]').value,
            frequency_per_day: parseInt(row.querySelector('input[name="frequency_per_day"]').value),
            tablets_per_dose: parseFloat(row.querySelector('input[name="tablets_per_dose"]').value),
            remaining_tablets: parseFloat(row.querySelector('input[name="remaining_tablets"]').value),
            refill_date: row.querySelector('input[name="refill_date"]').value || null
        };
        // Calculate refill date if not specified
if (!medicationData.refill_date) {
    // Calculate days remaining based on usage
    const dailyUsage = medicationData.frequency_per_day * medicationData.tablets_per_dose;
    const daysRemaining = Math.floor(medicationData.remaining_tablets / dailyUsage);
    
    // Set refill date to calculated date
    const calculatedRefillDate = new Date();
    calculatedRefillDate.setDate(calculatedRefillDate.getDate() + daysRemaining);
    
    // Format date as YYYY-MM-DD for the input
    const year = calculatedRefillDate.getFullYear();
    const month = String(calculatedRefillDate.getMonth() + 1).padStart(2, '0');
    const day = String(calculatedRefillDate.getDate()).padStart(2, '0');
    medicationData.refill_date = `${year}-${month}-${day}`;
}
        // Validate required fields// Validate required fields (continuation)
        if (!medicationData.name) {
            showMessage('Medication name is required', 'error');
            return;
        }
        
        // Check for invalid values
        if (isNaN(medicationData.frequency_per_day) || medicationData.frequency_per_day < 1) {
            showMessage('Frequency must be at least 1', 'error');
            return;
        }
        
        if (isNaN(medicationData.tablets_per_dose) || medicationData.tablets_per_dose < 0.5) {
            showMessage('Tablets per dose must be at least 0.5', 'error');
            return;
        }
        
        if (isNaN(medicationData.remaining_tablets) || medicationData.remaining_tablets < 0) {
            showMessage('Remaining tablets cannot be negative', 'error');
            return;
        }
        
        // Log the data being sent (for debugging)
        console.log("Sending medication data:", medicationData);
        
        // Determine if it's an update or new medication
        const url = medicationId ? 
            `/api/medications/${medicationId}/` : 
            '/api/medications/';
        
        const method = medicationId ? 'PUT' : 'POST';
        
        // Save the medication
        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(medicationData)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errData => {
                    // If the server returns error details, throw them
                    throw new Error(errData.error || 'Network response was not ok');
                });
            }
            return response.json();
        })
        .then(data => {
            showMessage(`Medication ${medicationId ? 'updated' : 'added'} successfully`, 'success');
            
            // Reload medications to show updated data
            loadMedications();
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage(`Error ${medicationId ? 'updating' : 'adding'} medication: ` + error.message, 'error');
        });
    }
    
    // Helper function to get directions text
    function getDirectionsText(medication) {
        let frequency = '';
        switch(medication.frequency_per_day) {
            case 1:
                frequency = 'once daily';
                break;
            case 2:
                frequency = 'twice daily';
                break;
            case 3:
                frequency = 'three times daily';
                break;
            case 4:
                frequency = 'four times daily';
                break;
            default:
                frequency = `${medication.frequency_per_day}x daily`;
        }
        
        let tablets = '';
        if (medication.tablets_per_dose === 1) {
            tablets = 'Take one tablet';
        } else {
            tablets = `Take ${medication.tablets_per_dose} tablets`;
        }
        
        // Use description if available, otherwise construct generic directions
        if (medication.description && medication.description.trim() !== '') {
            return medication.description;
        } else {
            return `${tablets} by mouth ${frequency}`;
        }
    }
    
    // Setup handlers for medication cards
    function setupMedicationHandlers() {
        // Edit medication buttons
        document.querySelectorAll('.edit-medication').forEach(button => {
            button.addEventListener('click', function() {
                const medicationId = this.closest('.medication-card').dataset.id;
                openMedicationModal(medicationId);
            });
        });
        
        // Delete medication buttons
        document.querySelectorAll('.delete-medication').forEach(button => {
            button.addEventListener('click', function() {
                const medicationCard = this.closest('.medication-card');
                const medicationId = medicationCard.dataset.id;
                const medicationName = medicationCard.querySelector('.medication-name').textContent;
                
                if (confirm(`Are you sure you want to delete ${medicationName}?`)) {
                    fetch(`/api/medications/${medicationId}/`, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        medicationCard.remove();
                        showMessage('Medication deleted successfully', 'success');
                        
                        // Show empty state if no medications left
                        if (medicationList.children.length === 0) {
                            medicationList.innerHTML = '<div class="empty-state">You don\'t have any medications added yet.</div>';
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showMessage('Error deleting medication: ' + error.message, 'error');
                    });
                }
            });
        });
        
        // Refill medication buttons
        document.querySelectorAll('.refill-medication').forEach(button => {
            button.addEventListener('click', function() {
                const medicationCard = this.closest('.medication-card');
                const medicationId = medicationCard.dataset.id;
                
                fetch(`/api/medications/${medicationId}/refill/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    showMessage('Medication refilled successfully', 'success');
                    // Reload medications to show updated counts and dates
                    loadMedications();
                })
                .catch(error => {
                    console.error('Error:', error);
                    showMessage('Error refilling medication: ' + error.message, 'error');
                });
            });
        });
    }
    
    // Function to open medication modal
    function openMedicationModal(medicationId = null) {
        modalTitle.textContent = medicationId ? 'Edit Medication' : 'Add Medication';
        medicationForm.reset();
        document.getElementById('medicationId').value = medicationId || '';
        
        if (medicationId) {
            // Fetch medication details and populate form
            fetch(`/api/medications/${medicationId}/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(med => {
                    document.getElementById('medName').value = med.name;
                    document.getElementById('medDescription').value = med.description || '';
                    document.getElementById('medFrequency').value = med.frequency_per_day;
                    document.getElementById('medDosage').value = med.tablets_per_dose;
                    document.getElementById('medRemaining').value = med.remaining_tablets;
                    if (med.refill_date) {
                        document.getElementById('medRefillDate').value = med.refill_date.split('T')[0];
                    }
                })
                .catch(error => {
                    console.error('Error fetching medication:', error);
                    showMessage('Error loading medication details', 'error');
                });
        }
        
        medicationModal.style.display = 'block';
    }
    
    // Function to close medication modal
    function closeMedicationModal() {
        medicationModal.style.display = 'none';
        medicationForm.reset();
    }
});
       
</script>
</body>


</html>
{% endblock %}
