{% extends 'base.html' %} {% load static %} {% block title %}Profile -
RxHarmony{% endblock %} {% block content %}
<style>
  /* Main profile styles */
  .profile-page {
    background-color: #f8f9fa;
    min-height: 100vh;
    padding: 20px 0;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 15px;
  }

  .page-title {
    font-size: 24px;
    font-weight: 600;
    color: #333;
    margin-bottom: 20px;
  }

  /* Card styles */
  .card {
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid #eee;
  }

  .card-title {
    font-size: 18px;
    font-weight: 600;
    color: #333;
    margin: 0;
  }

  .card-body {
    padding: 20px;
  }

  /* Grid layout */
  .profile-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
  }

  @media (min-width: 992px) {
    .profile-grid {
      grid-template-columns: 2fr 1fr;
    }
  }

  /* User info styles */
  .info-section {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
  }

  .info-item {
    margin-bottom: 15px;
  }

  .info-label {
    font-size: 14px;
    font-weight: 500;
    color: #666;
    margin-bottom: 5px;
  }

  .info-value {
    font-size: 16px;
    color: #333;
  }

  .empty-state {
    color: #999;
    font-style: italic;
  }

  /* Action buttons */
  .btn {
    display: inline-block;
    font-weight: 500;
    text-align: center;
    white-space: nowrap;
    vertical-align: middle;
    user-select: none;
    border: 1px solid transparent;
    padding: 0.375rem 0.75rem;
    font-size: 14px;
    line-height: 1.5;
    border-radius: 4px;
    transition: all 0.15s ease-in-out;
    text-decoration: none;
  }

  .btn-primary {
    color: #fff;
    background-color: #0066ff;
    border-color: #0066ff;
  }

  .btn-primary:hover {
    background-color: #0055dd;
    border-color: #0055dd;
  }

  /* Medication cards */
  .medication-cards {
    margin-top: 20px;
  }

  .medication-card {
    margin-bottom: 15px;
    border: 1px solid #eee;
    border-radius: 8px;
  }

  .medication-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }

  .medication-name {
    font-size: 16px;
    font-weight: 600;
    margin: 0;
  }

  .medication-details {
    margin-bottom: 15px;
  }

  .progress {
    height: 12px;
    background-color: #e9ecef;
    border-radius: 6px;
    overflow: hidden;
  }

  .progress-bar {
    height: 100%;
    border-radius: 6px;
  }

  .bg-primary {
    background-color: #0066ff;
  }

  .bg-warning {
    background-color: #ff9500;
  }

  .bg-danger {
    background-color: #ff3b30;
  }

  /* Calendar styles */
  .calendar {
    width: 100%;
    margin-bottom: 20px;
  }

  .calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }

  .calendar-title {
    font-size: 16px;
    font-weight: 600;
  }

  .calendar-nav {
    display: flex;
    gap: 10px;
  }

  .calendar-nav-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: #0066ff;
    font-size: 18px;
  }

  .calendar-table {
    width: 100%;
    border-collapse: collapse;
  }

  .calendar-table th {
    padding: 8px;
    text-align: center;
    font-size: 12px;
    font-weight: 500;
    color: #666;
  }

  .calendar-table td {
    padding: 8px;
    text-align: center;
    font-size: 14px;
    color: #333;
    border-radius: 50%;
    width: 36px;
    height: 36px;
  }

  .calendar-table td.today {
    background-color: #0066ff;
    color: white;
  }

  .calendar-table td.has-med {
    position: relative;
  }

  .calendar-table td.has-med::after {
    content: "";
    position: absolute;
    bottom: 2px;
    left: 50%;
    transform: translateX(-50%);
    width: 4px;
    height: 4px;
    border-radius: 50%;
    background-color: #0066ff;
  }

  /* Allergy dropdown */
  .dropdown {
    position: relative;
    margin-bottom: 20px;
  }

  .dropdown-toggle {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
    background-color: #f5f7fa;
    border: 1px solid #eee;
    border-radius: 4px;
    cursor: pointer;
  }

  .dropdown-toggle.active {
    border-color: #0066ff;
  }

  .dropdown-menu {
    display: none;
    background-color: white;
    border: 1px solid #eee;
    border-radius: 4px;
    padding: 10px 15px;
    margin-top: 5px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  }

  .dropdown-menu.show {
    display: block;
  }

  /* Medication form styles */
  .medication-form {
    display: none;
  }

  .medication-form.show {
    display: block;
  }

  .form-row {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
  }

  .form-group {
    flex: 1;
  }

  .form-label {
    display: block;
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 5px;
    color: #666;
  }

  .form-control {
    width: 100%;
    padding: 8px 12px;
    font-size: 14px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background-color: #f5f7fa;
  }

  .form-control:focus {
    outline: none;
    border-color: #0066ff;
  }

  /* Upcoming refills section */
  .refills-list {
    list-style-type: none;
    padding: 0;
    margin: 0;
  }

  .refill-item {
    padding: 10px 0;
    border-bottom: 1px solid #eee;
  }

  .refill-item:last-child {
    border-bottom: none;
  }

  .refill-date {
    font-size: 12px;
    color: #666;
  }

  .refill-med {
    font-size: 14px;
    font-weight: 500;
    color: #333;
  }
</style>

<div class="profile-page">
  <div class="container">
    <div class="profile-grid">
      <!-- Left Column - User Info and Medications -->
      <div>
        <!-- Patient Information Card -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Patient Information</h2>
            <a href="{% url 'profile_setup' %}" class="btn btn-primary"
              >Edit Profile</a
            >
          </div>
          <div class="card-body">
            <div class="info-section">
              <div class="info-item">
                <div class="info-label">Patient ID</div>
                <div class="info-value">
                  PT-{{ user.id|stringformat:"05d" }}
                </div>
              </div>
              <div class="info-item">
                <div class="info-label">Date of Birth</div>
                <div class="info-value">
                  {% if profile.date_of_birth %} {{ profile.date_of_birth }} {%
                  else %}
                  <span class="empty-state">Not provided</span>
                  {% endif %}
                </div>
              </div>
              <div class="info-item">
                <div class="info-label">Email</div>
                <div class="info-value">{{ user.email }}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Primary Physician</div>
                <div class="info-value">
                  {% if profile.primary_physician %} {{
                  profile.primary_physician }} {% else %}
                  <span class="empty-state">Not provided</span>
                  {% endif %}
                </div>
              </div>
              <div class="info-item">
                <div class="info-label">Gender</div>
                <div class="info-value">
                  {% if profile.gender %} {{ profile.get_gender_display }} {%
                  else %}
                  <span class="empty-state">Not provided</span>
                  {% endif %}
                </div>
              </div>
              <div class="info-item">
                <div class="info-label">Blood Type</div>
                <div class="info-value">
                  {% if profile.blood_type %} {{ profile.blood_type }} {% else
                  %}
                  <span class="empty-state">Not provided</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Current Medications Card -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Current Medications</h2>
            <button id="addMedicationBtn" class="btn btn-primary">
              Add Medication
            </button>
          </div>
          <div class="card-body">
            <div id="addMedicationForm" class="medication-form">
              <form id="newMedicationForm">
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label" for="medName"
                      >Medication Name</label
                    >
                    <input
                      type="text"
                      id="medName"
                      class="form-control"
                      required
                    />
                  </div>
                  <div class="form-group">
                    <label class="form-label" for="refillDate"
                      >Refill Date</label
                    >
                    <input type="date" id="refillDate" class="form-control" />
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label" for="frequency"
                      >Frequency Per Day</label
                    >
                    <input
                      type="number"
                      id="frequency"
                      class="form-control"
                      min="1"
                      value="1"
                      required
                    />
                  </div>
                  <div class="form-group">
                    <label class="form-label" for="tablets"
                      >Tablets Per Dose</label
                    >
                    <input
                      type="number"
                      id="tablets"
                      class="form-control"
                      min="0.5"
                      step="0.5"
                      value="1"
                      required
                    />
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label" for="description"
                    >Description/Notes</label
                  >
                  <textarea
                    id="description"
                    class="form-control"
                    rows="2"
                  ></textarea>
                </div>
                <div class="form-row" style="margin-top: 15px">
                  <button type="submit" class="btn btn-primary">
                    Save Medication
                  </button>
                  <button
                    type="button"
                    id="cancelAddMed"
                    class="btn btn-secondary"
                    style="margin-left: 10px"
                  >
                    Cancel
                  </button>
                </div>
              </form>
            </div>

            <div id="medicationsList" class="medication-cards">
              <!-- Medication cards will be dynamically inserted here -->
              <!-- Example card for illustration -->
              <div class="medication-card">
                <div class="card-body">
                  <div class="medication-header">
                    <h5 class="medication-name">Metformin</h5>
                    <div>
                      <button class="btn btn-primary btn-sm edit-med">
                        Edit
                      </button>
                      <button class="btn btn-danger btn-sm delete-med">
                        Delete
                      </button>
                    </div>
                  </div>
                  <div class="medication-details">
                    <p>500 mg - tablet by mouth twice daily</p>
                    <div
                      style="
                        display: flex;
                        justify-content: space-between;
                        margin-bottom: 5px;
                      "
                    >
                      <span><strong>Refill:</strong> Mar 30, 2025</span>
                      <span><strong>Remaining:</strong> 30 of 30 tablets</span>
                    </div>
                    <div class="progress">
                      <div
                        class="progress-bar bg-primary"
                        style="width: 100%"
                      ></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Medical History Card with Allergies Dropdown -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Medical Information</h2>
          </div>
          <div class="card-body">
            <!-- Allergies Dropdown -->
            <div class="dropdown">
              <div class="dropdown-toggle" id="allergiesToggle">
                <span>Allergies</span>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </div>
              <div class="dropdown-menu" id="allergiesMenu">
                {% if profile.allergies %} {{ profile.allergies|linebreaks }} {%
                else %}
                <span class="empty-state">No allergies listed</span>
                {% endif %}
              </div>
            </div>

            <!-- Previous Medications Section -->
            <h3
              style="
                font-size: 16px;
                font-weight: 500;
                color: #666;
                margin-top: 20px;
              "
            >
              Previous Medications
            </h3>
            <div
              style="
                background-color: #f5f7fa;
                padding: 15px;
                border-radius: 4px;
              "
            >
              {% if medications %}
              <ul style="list-style-type: none; padding: 0; margin: 0">
                {% for medication in medications %}
                <li style="padding: 5px 0">{{ medication.name }}</li>
                {% endfor %}
              </ul>
              {% else %}
              <span class="empty-state">No previous medications listed</span>
              {% endif %}
            </div>

            <!-- Medical Conditions Section -->
            <h3
              style="
                font-size: 16px;
                font-weight: 500;
                color: #666;
                margin-top: 20px;
              "
            >
              Medical Conditions
            </h3>
            <div
              style="
                background-color: #f5f7fa;
                padding: 15px;
                border-radius: 4px;
              "
            >
              {% if conditions %}
              <ul style="list-style-type: none; padding: 0; margin: 0">
                {% for condition in conditions %}
                <li style="padding: 5px 0">{{ condition.name }}</li>
                {% endfor %}
              </ul>
              {% else %}
              <span class="empty-state">No conditions listed</span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column - Calendar and Refills -->
      <div>
        <!-- Calendar Card -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Medication Calendar</h2>
          </div>
          <div class="card-body">
            <div class="calendar">
              <div class="calendar-header">
                <button id="prevMonth" class="calendar-nav-btn">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <polyline points="15 18 9 12 15 6"></polyline>
                  </svg>
                </button>
                <div class="calendar-title" id="currentMonth">March 2025</div>
                <button id="nextMonth" class="calendar-nav-btn">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <polyline points="9 18 15 12 9 6"></polyline>
                  </svg>
                </button>
              </div>
              <table class="calendar-table">
                <thead>
                  <tr>
                    <th>Sun</th>
                    <th>Mon</th>
                    <th>Tue</th>
                    <th>Wed</th>
                    <th>Thu</th>
                    <th>Fri</th>
                    <th>Sat</th>
                  </tr>
                </thead>
                <tbody id="calendarBody">
                  <!-- Calendar days will be inserted here -->
                </tbody>
              </table>
            </div>

            <div style="margin-top: 20px">
              <h3 style="font-size: 16px; color: #333; margin-bottom: 10px">
                Upcoming Refills
              </h3>
              <ul class="refills-list" id="upcomingRefills">
                <!-- Upcoming refills will be inserted here -->
              </ul>
            </div>
          </div>
        </div>

        <!-- Daily Tracking Card -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Daily Tracking</h2>
          </div>
          <div class="card-body">
            <div style="margin-bottom: 15px">
              <label class="form-label" for="trackingDate">Select Date</label>
              <input type="date" id="trackingDate" class="form-control" />
            </div>

            <div id="dailyTrackingList">
              <!-- Daily tracking items will be inserted here -->
            </div>

            <button
              id="saveTracking"
              class="btn btn-primary"
              style="margin-top: 15px"
            >
              Save Tracking
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Medication Item Template -->
<template id="medicationItemTemplate">
  <div class="medication-card">
    <div class="card-body">
      <div class="medication-header">
        <h5 class="medication-name"></h5>
        <div>
          <button class="btn btn-primary btn-sm edit-med">Edit</button>
          <button class="btn btn-danger btn-sm delete-med">Delete</button>
        </div>
      </div>
      <div class="medication-details">
        <p class="description"></p>
        <div
          style="
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
          "
        >
          <span
            ><strong>Refill:</strong> <span class="refill-date"></span
          ></span>
          <span
            ><strong>Frequency:</strong>
            <span class="frequency"></span> times/day</span
          >
        </div>
        <div
          style="
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
          "
        >
          <span
            ><strong>Tablets:</strong> <span class="tablets"></span> per
            dose</span
          >
          <span
            ><strong>Remaining:</strong> <span class="remaining-count"></span
          ></span>
        </div>
        <div class="progress">
          <div class="remaining-bar progress-bar bg-primary"></div>
        </div>
      </div>
      <div class="medication-form">
        <form class="edit-medication-form">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Medication Name</label>
              <input type="text" class="form-control edit-name" required />
            </div>
            <div class="form-group">
              <label class="form-label">Refill Date</label>
              <input type="date" class="form-control edit-refill" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Frequency Per Day</label>
              <input
                type="number"
                class="form-control edit-frequency"
                min="1"
                required
              />
            </div>
            <div class="form-group">
              <label class="form-label">Tablets Per Dose</label>
              <input
                type="number"
                class="form-control edit-tablets"
                min="0.5"
                step="0.5"
                required
              />
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Description/Notes</label>
            <textarea class="form-control edit-description" rows="2"></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Remaining Tablets</label>
            <input
              type="number"
              class="form-control edit-remaining-tablets"
              min="0"
              step="0.5"
              required
            />
          </div>
          <div class="form-row" style="margin-top: 15px">
            <button type="submit" class="btn btn-primary save-changes">
              Save
            </button>
            <button
              type="button"
              class="btn btn-secondary cancel-edit"
              style="margin-left: 10px"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</template>

<!-- Daily Tracking Template -->
<template id="dailyTrackingTemplate">
  <div class="medication-card">
    <div class="card-body">
      <div class="medication-header">
        <h5 class="tracking-name"></h5>
        <small>(<span class="tracking-tablets"></span> tablets per dose)</small>
      </div>
      <div
        class="checkbox-container"
        style="display: flex; gap: 15px; margin-top: 10px"
      >
        <!-- Checkboxes will be generated dynamically -->
      </div>
    </div>
  </div>
</template>

<script>
  // Your existing JavaScript
  let trackingData = {};
  let medications = []; // This will be populated via AJAX

  document.addEventListener("DOMContentLoaded", function () {
    // Initialize allergies dropdown
    const allergiesToggle = document.getElementById("allergiesToggle");
    const allergiesMenu = document.getElementById("allergiesMenu");

    allergiesToggle.addEventListener("click", function () {
      allergiesMenu.classList.toggle("show");
      allergiesToggle.classList.toggle("active");
    });

    // Initialize add medication form toggle
    const addMedicationBtn = document.getElementById("addMedicationBtn");
    const addMedicationForm = document.getElementById("addMedicationForm");
    const cancelAddMed = document.getElementById("cancelAddMed");

    addMedicationBtn.addEventListener("click", function () {
      addMedicationForm.classList.add("show");
    });

    cancelAddMed.addEventListener("click", function () {
      addMedicationForm.classList.remove("show");
      document.getElementById("newMedicationForm").reset();
    });

    // Set today's date as default for tracking
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("trackingDate").value = today;

    // Initialize calendar
    initCalendar();

    // Fetch medications from the server
    fetchMedications();

    // Add event listeners for your existing functionality
    document
      .getElementById("newMedicationForm")
      .addEventListener("submit", addMedication);
    document
      .getElementById("trackingDate")
      .addEventListener("change", loadDailyTracking);
    document
      .getElementById("saveTracking")
      .addEventListener("click", saveTracking);
    document.getElementById("prevMonth").addEventListener("click", function () {
      navigateMonth(-1);
    });
    document.getElementById("nextMonth").addEventListener("click", function () {
      navigateMonth(1);
    });
  });

  function initCalendar() {
    const currentDate = new Date();
    renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
  }

  function renderCalendar(year, month) {
    const currentMonthText = document.getElementById("currentMonth");
    const calendarBody = document.getElementById("calendarBody");

    const monthNames = [
      "January",
      "February",
      "March",
      "April",
      "May",
      "June",
      "July",
      "August",
      "September",
      "October",
      "November",
      "December",
    ];

    // Update month display
    currentMonthText.textContent = `${monthNames[month]} ${year}`;

    // Get first day of month and total days
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    // Current date for highlighting today
    const today = new Date();
    const currentDay = today.getDate();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();

    // Clear previous calendar
    calendarBody.innerHTML = "";

    // Create calendar rows and cells
    let date = 1;
    for (let i = 0; i < 6; i++) {
      const row = document.createElement("tr");

      for (let j = 0; j < 7; j++) {
        const cell = document.createElement("td");

        if (i === 0 && j < firstDay) {
          // Empty cells before the first day of month
          cell.textContent = "";
        } else if (date > daysInMonth) {
          // Empty cells after the last day of month
          break;
        } else {
          // Regular day cells
          cell.textContent = date;

          // Highlight today
          if (
            date === currentDay &&
            month === currentMonth &&
            year === currentYear
          ) {
            cell.classList.add("today");
          }

          // Mark dates with medications (example)
          // You would replace this with actual data from your medications
          if ((date % 7 === 0 || date % 7 === 3) && medications.length > 0) {
            cell.classList.add("has-med");
          }

          date++;
        }

        row.appendChild(cell);
      }

      calendarBody.appendChild(row);

      // Stop if we've displayed all days
      if (date > daysInMonth) {
        break;
      }
    }

    // Update upcoming refills
    updateUpcomingRefills(year, month);
  }

  function navigateMonth(direction) {
    const currentMonthText =
      document.getElementById("currentMonth").textContent;
    const [monthName, year] = currentMonthText.split(" ");

    const monthNames = [
      "January",
      "February",
      "March",
      "April",
      "May",
      "June",
      "July",
      "August",
      "September",
      "October",
      "November",
      "December",
    ];

    let monthIndex = monthNames.indexOf(monthName);
    let newYear = parseInt(year);

    monthIndex += direction;

    if (monthIndex < 0) {
      monthIndex = 11;
      newYear--;
    } else if (monthIndex > 11) {
      monthIndex = 0;
      newYear++;
    }

    renderCalendar(newYear, monthIndex);
  }

  function updateUpcomingRefills(year, month) {
    const refillsList = document.getElementById("upcomingRefills");
    refillsList.innerHTML = "";

    // Example refill data - you would replace this with your actual medication data
    if (medications.length > 0) {
      medications.forEach((med) => {
        if (med.refill_date) {
          const refillDate = new Date(med.refill_date);
          const currentDate = new Date(year, month, 1);

          // Only show refills for the current month or the next month
          if (
            refillDate.getMonth() === currentDate.getMonth() ||
            refillDate.getMonth() === (currentDate.getMonth() + 1) % 12
          ) {
            const item = document.createElement("li");
            item.className = "refill-item";

            const dateSpan = document.createElement("div");
            dateSpan.className = "refill-date";
            dateSpan.textContent = refillDate.toLocaleDateString();

            const medSpan = document.createElement("div");
            medSpan.className = "refill-med";
            medSpan.textContent = med.name;

            item.appendChild(dateSpan);
            item.appendChild(medSpan);
            refillsList.appendChild(item);
          }
        }
      });
    }

    if (refillsList.children.length === 0) {
      const emptyItem = document.createElement("li");
      emptyItem.className = "refill-item";
      emptyItem.innerHTML =
        '<span class="empty-state">No upcoming refills</span>';
      refillsList.appendChild(emptyItem);
    }
  }

  // Toggle edit mode for medication cards
  function toggleEditMode(card) {
    const detailsDiv = card.querySelector(".medication-details");
    const formDiv = card.querySelector(".medication-form");

    if (detailsDiv.style.display === "none") {
      detailsDiv.style.display = "block";
      formDiv.style.display = "none";
    } else {
      detailsDiv.style.display = "none";
      formDiv.style.display = "block";
    }
  }

  // Fetch medications from the server
  function fetchMedications() {
    fetch("/api/medications/")
      .then((response) => {
        if (!response.ok) {
          throw new Error("Network response was not ok");
        }
        return response.json();
      })
      .then((data) => {
        // Make sure we're using the medications array from the response
        medications = data.medications; // This is the key change

        // Debug output to console
        console.log("Received medications data:", medications);

        if (!Array.isArray(medications)) {
          console.error("medications is not an array:", medications);
          medications = []; // Fallback to empty array to prevent errors
        }

        loadMedications();
        loadDailyTracking();

        // Refresh the calendar with medication dates
        const currentMonthText =
          document.getElementById("currentMonth").textContent;
        const [monthName, year] = currentMonthText.split(" ");

        const monthNames = [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ];

        renderCalendar(parseInt(year), monthNames.indexOf(monthName));
      })
      .catch((error) => {
        console.error("Error fetching medications:", error);
        document.getElementById(
          "medicationsList"
        ).innerHTML = `<div class="alert alert-danger">Error loading medications: ${error.message}</div>`;
      });
  }

  // Load medications into the manage tab
  function loadMedications() {
    const medicationsList = document.getElementById("medicationsList");
    medicationsList.innerHTML = "";

    if (medications.length === 0) {
      medicationsList.innerHTML =
        "<p class='empty-state'>No medications added yet.</p>";
      return;
    }

    medications.forEach((med) => {
      const template = document.getElementById("medicationItemTemplate");
      const clone = template.content.cloneNode(true);

      clone.querySelector(".medication-name").textContent = med.name;
      clone.querySelector(".description").textContent =
        med.description || "No description";
      clone.querySelector(".refill-date").textContent =
        med.refill_date || "Not set";
      clone.querySelector(".frequency").textContent = med.frequency_per_day;
      clone.querySelector(".tablets").textContent = med.tablets_per_dose;

      // Add remaining tablets display
      if (clone.querySelector(".remaining-count")) {
        clone.querySelector(
          ".remaining-count"
        ).textContent = `${med.remaining_tablets} of 30 tablets`;
      }

      // Update progress bar width based on remaining percentage
      if (clone.querySelector(".remaining-bar")) {
        const percentage = (med.remaining_tablets / 30) * 100;
        clone.querySelector(".remaining-bar").style.width = `${percentage}%`;

        // Change color based on percentage (red < 20%, yellow < 50%, blue otherwise)
        let barColor = "bg-primary"; // Default blue
        if (percentage < 20) {
          barColor = "bg-danger"; // Red for low
        } else if (percentage < 50) {
          barColor = "bg-warning"; // Yellow for medium
        }

        clone.querySelector(".remaining-bar").className = clone
          .querySelector(".remaining-bar")
          .className.replace(/bg-\w+/, barColor);
      }

      // Set form fields for editing
      clone.querySelector(".edit-name").value = med.name;
      clone.querySelector(".edit-refill").value = med.refill_date || "";
      clone.querySelector(".edit-frequency").value = med.frequency_per_day;
      clone.querySelector(".edit-tablets").value = med.tablets_per_dose;
      clone.querySelector(".edit-description").value = med.description || "";

      // Set remaining tablets field
      if (clone.querySelector(".edit-remaining-tablets")) {
        clone.querySelector(".edit-remaining-tablets").value =
          med.remaining_tablets;
      }

      // Set data attribute for medication ID
      const card = clone.querySelector(".medication-card");
      card.dataset.id = med.id;

      // Add event listeners for edit/delete
      card.querySelector(".edit-med").addEventListener("click", function () {
        toggleEditMode(card);
      });

      card.querySelector(".delete-med").addEventListener("click", function () {
        deleteMedication(med.id);
      });

      card.querySelector(".cancel-edit").addEventListener("click", function () {
        toggleEditMode(card);
      });

      card
        .querySelector(".edit-medication-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          saveMedicationChanges(card);
        });

      medicationsList.appendChild(clone);
    });
  }

  // Load daily tracking tab
  function loadDailyTracking() {
    const dailyList = document.getElementById("dailyTrackingList");
    dailyList.innerHTML = "";

    if (medications.length === 0) {
      dailyList.innerHTML =
        "<p class='empty-state'>No medications to track.</p>";
      return;
    }

    const selectedDate = document.getElementById("trackingDate").value;

    // Fetch tracking data for the selected date if available
    fetchTrackingData(selectedDate)
      .then(() => {
        // Initialize tracking data for this date if it doesn't exist
        if (!trackingData[selectedDate]) {
          trackingData[selectedDate] = {};
        }

        medications.forEach((med) => {
          // Initialize tracking data for this medication if it doesn't exist
          if (!trackingData[selectedDate][med.id]) {
            trackingData[selectedDate][med.id] = Array(
              med.frequency_per_day
            ).fill(false);
          }

          // Make sure the array has the correct length
          if (
            trackingData[selectedDate][med.id].length !== med.frequency_per_day
          ) {
            // If medication frequency has changed, resize the array
            const oldData = trackingData[selectedDate][med.id];
            trackingData[selectedDate][med.id] = Array(
              med.frequency_per_day
            ).fill(false);

            // Preserve existing data as much as possible
            for (
              let i = 0;
              i < Math.min(oldData.length, med.frequency_per_day);
              i++
            ) {
              trackingData[selectedDate][med.id][i] = oldData[i];
            }
          }

          const template = document.getElementById("dailyTrackingTemplate");
          const clone = template.content.cloneNode(true);

          clone.querySelector(".tracking-name").textContent = med.name;
          clone.querySelector(".tracking-tablets").textContent =
            med.tablets_per_dose;

          const card = clone.querySelector(".medication-card");
          card.dataset.id = med.id;

          const checkboxContainer = clone.querySelector(".checkbox-container");

          // Create checkboxes based on frequency
          for (let i = 0; i < med.frequency_per_day; i++) {
            const checkItem = document.createElement("div");
            checkItem.className = "check-item";

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.id = `med-${med.id}-dose-${i}`;
            checkbox.checked = trackingData[selectedDate][med.id][i];
            checkbox.addEventListener("change", function () {
              trackingData[selectedDate][med.id][i] = this.checked;
            });

            const label = document.createElement("label");
            label.htmlFor = `med-${med.id}-dose-${i}`;
            label.textContent = getDoseLabel(i);

            checkItem.appendChild(checkbox);
            checkItem.appendChild(label);
            checkboxContainer.appendChild(checkItem);
          }

          dailyList.appendChild(clone);
        });
      })
      .catch((error) => {
        console.error("Error loading tracking data:", error);
        dailyList.innerHTML = `<div class="alert alert-danger">Error loading tracking data: ${error.message}</div>`;
      });
  }

  // Helper function to get dose label
  function getDoseLabel(index) {
    const labels = ["Morning", "Noon", "Evening", "Night"];
    return index < labels.length ? labels[index] : `Dose ${index + 1}`;
  }

  // Fetch tracking data for a specific date
  function fetchTrackingData(date) {
    return fetch(`/api/tracking/${date}/`)
      .then((response) => {
        if (!response.ok) {
          // If 404, it just means no data yet for this date, which is fine
          if (response.status === 404) {
            return { tracking: {} };
          }
          throw new Error("Network response was not ok");
        }
        return response.json();
      })
      .then((data) => {
        if (data && data.tracking) {
          trackingData[date] = data.tracking;
        } else {
          // Initialize empty tracking data if none exists
          trackingData[date] = {};
        }
      })
      .catch((error) => {
        // Just log the error and continue with empty tracking data
        console.error("Error fetching tracking data:", error);
        trackingData[date] = {};
      });
  }

  // Add a new medication
  function addMedication(e) {
    e.preventDefault();

    const newMed = {
      name: document.getElementById("medName").value,
      description: document.getElementById("description").value,
      refill_date: document.getElementById("refillDate").value,
      frequency_per_day: parseInt(document.getElementById("frequency").value),
      tablets_per_dose: parseFloat(document.getElementById("tablets").value),
      remaining_tablets: 30, // Always start with 30 tablets
    };

    // Send the new medication to the server
    fetch("/api/medications/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCsrfToken(),
      },
      body: JSON.stringify(newMed),
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error("Network response was not ok");
        }
        return response.json();
      })
      .then((data) => {
        // Reset form
        document.getElementById("newMedicationForm").reset();
        document.getElementById("addMedicationForm").classList.remove("show");

        // Refresh medications list
        fetchMedications();
      })
      .catch((error) => {
        console.error("Error adding medication:", error);
        alert(`Error adding medication: ${error.message}`);
      });
  }

  // Save changes to a medication
  function saveMedicationChanges(card) {
    const medId = parseInt(card.dataset.id);

    const updatedMed = {
      id: medId,
      name: card.querySelector(".edit-name").value,
      description: card.querySelector(".edit-description").value,
      refill_date: card.querySelector(".edit-refill").value,
      frequency_per_day: parseInt(card.querySelector(".edit-frequency").value),
      tablets_per_dose: parseFloat(card.querySelector(".edit-tablets").value),
      remaining_tablets: parseFloat(
        card.querySelector(".edit-remaining-tablets").value
      ),
    };

    // Send the updated medication to the server
    fetch(`/api/medications/${medId}/`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCsrfToken(),
      },
      body: JSON.stringify(updatedMed),
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error("Network response was not ok");
        }
        return response.json();
      })
      .then((data) => {
        // After successful update, refresh the medications
        fetchMedications();
        toggleEditMode(card);
      })
      .catch((error) => {
        console.error("Error updating medication:", error);
        alert(`Error updating medication: ${error.message}`);
      });
  }

  // Delete a medication
  function deleteMedication(medId) {
    if (confirm("Are you sure you want to delete this medication?")) {
      fetch(`/api/medications/${medId}/`, {
        method: "DELETE",
        headers: {
          "X-CSRFToken": getCsrfToken(),
        },
      })
        .then((response) => {
          if (!response.ok) {
            throw new Error("Network response was not ok");
          }
          // After successful deletion, refresh the medications
          fetchMedications();
        })
        .catch((error) => {
          console.error("Error deleting medication:", error);
          alert(`Error deleting medication: ${error.message}`);
        });
    }
  }

  // Save tracking data
  function saveTracking() {
    const selectedDate = document.getElementById("trackingDate").value;

    fetch(`/api/tracking/${selectedDate}/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCsrfToken(),
      },
      body: JSON.stringify({
        tracking: trackingData[selectedDate],
      }),
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error("Network response was not ok");
        }
        return response.json();
      })
      .then((data) => {
        alert("Tracking data saved successfully!");
        // Refresh medications to update the tablet count display
        fetchMedications();
      })
      .catch((error) => {
        console.error("Error saving tracking data:", error);
        alert(`Error saving tracking data: ${error.message}`);
      });
  }

  // Helper function to get CSRF token from cookies
  function getCsrfToken() {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, "csrftoken".length + 1) === "csrftoken=") {
          cookieValue = decodeURIComponent(
            cookie.substring("csrftoken".length + 1)
          );
          break;
        }
      }
    }
    return cookieValue;
  }
</script>
{% endblock %}
