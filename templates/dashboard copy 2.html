{% extends 'base.html' %} {% load static %} {% block title %}Medication
Dashboard{% endblock %} {% block extra_css %}
<style>
  /* Global styles */
  body {
    font-family: "Roboto", "Segoe UI", sans-serif;
    color: #333;
    background-color: #f8f9fa;
  }

  .container {
    max-width: 1200px;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
    background-color: #fff;
    border-radius: 8px;
    padding: 2rem;
    margin-top: 2rem;
    margin-bottom: 2rem;
  }

  h1 {
    color: #2c3e50;
    font-weight: 600;
    border-bottom: 2px solid #3498db;
    padding-bottom: 0.5rem;
    margin-bottom: 1.5rem;
  }

  h2 {
    color: #2c3e50;
    font-size: 1.5rem;
    font-weight: 500;
  }

  /* Tab styling */
  .nav-tabs {
    border-bottom: 2px solid #e9ecef;
  }

  .nav-tabs .nav-link {
    color: #6c757d;
    font-weight: 500;
    border: none;
    padding: 0.75rem 1.25rem;
    transition: all 0.3s ease;
  }

  .nav-tabs .nav-link:hover {
    color: #3498db;
    background-color: rgba(52, 152, 219, 0.05);
  }

  .nav-tabs .nav-link.active {
    color: #3498db;
    border: none;
    border-bottom: 3px solid #3498db;
    background-color: transparent;
  }

  /* Button styling */
  .btn-primary {
    background-color: #3498db;
    border-color: #3498db;
    box-shadow: 0 2px 4px rgba(52, 152, 219, 0.2);
    transition: all 0.3s ease;
  }

  .btn-primary:hover {
    background-color: #2980b9;
    border-color: #2980b9;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
  }

  .btn-warning {
    background-color: #f39c12;
    border-color: #f39c12;
    color: white;
    box-shadow: 0 2px 4px rgba(243, 156, 18, 0.2);
  }

  .btn-warning:hover {
    background-color: #e67e22;
    border-color: #e67e22;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(243, 156, 18, 0.3);
  }

  .btn-outline-primary {
    color: #3498db;
    border-color: #3498db;
  }

  .btn-outline-primary:hover {
    background-color: #3498db;
    color: white;
  }

  .btn-outline-danger {
    color: #e74c3c;
    border-color: #e74c3c;
  }

  .btn-outline-danger:hover {
    background-color: #e74c3c;
    color: white;
  }

  /* Table styling */
  .table {
    border-collapse: separate;
    border-spacing: 0;
  }

  .table th {
    background-color: #f8f9fa;
    color: #2c3e50;
    font-weight: 600;
    border-top: none;
    text-transform: uppercase;
    font-size: 0.85rem;
    letter-spacing: 0.5px;
  }

  .table td {
    vertical-align: middle;
    border-top: 1px solid #e9ecef;
  }

  .table-striped tbody tr:nth-of-type(odd) {
    background-color: rgba(52, 152, 219, 0.03);
  }

  /* Card styling */
  .card {
    border: none;
    border-radius: 8px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    overflow: hidden;
  }

  .card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  }

  .card-header {
    background-color: #3498db;
    color: white;
    font-weight: 500;
    border-bottom: none;
    padding: 0.75rem 1.25rem;
  }

  .card-body {
    padding: 1.5rem;
  }

  /* Form styling */
  .form-control {
    border-radius: 6px;
    border: 1px solid #ced4da;
    padding: 0.75rem 1rem;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
  }

  .form-control:focus {
    border-color: #3498db;
    box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
  }

  .form-label {
    font-weight: 500;
    color: #495057;
    margin-bottom: 0.5rem;
  }

  /* Checkbox styling */
  .form-check-input {
    cursor: pointer;
    width: 1.25rem;
    height: 1.25rem;
    margin-top: 0.25rem;
  }

  .form-check-input:checked {
    background-color: #3498db;
    border-color: #3498db;
  }

  .form-check-label {
    cursor: pointer;
    padding-left: 0.5rem;
  }

  /* Alert styling */
  .alert-info {
    background-color: rgba(52, 152, 219, 0.1);
    border-color: rgba(52, 152, 219, 0.2);
    color: #2980b9;
    border-radius: 6px;
    padding: 1rem 1.5rem;
  }

  /* Modal styling */
  .modal-content {
    border: none;
    border-radius: 8px;
    box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
  }

  .modal-header {
    background-color: #3498db;
    color: white;
    border-bottom: none;
    border-radius: 8px 8px 0 0;
  }

  .modal-title {
    font-weight: 500;
  }

  .modal-footer {
    border-top: 1px solid #e9ecef;
    padding: 1.25rem;
  }

  .btn-close {
    color: white;
    opacity: 0.8;
  }

  /* Date display */
  .date-display {
    background-color: #f8f9fa;
    padding: 0.75rem 1.25rem;
    border-radius: 6px;
    font-size: 1.1rem;
    border-left: 4px solid #3498db;
  }

  /* Medication doses section */
  .medication-doses {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-top: 1rem;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .container {
      padding: 1rem;
    }

    .table th,
    .table td {
      font-size: 0.85rem;
    }
  }
</style>
{% endblock %} {% block content %}
<div class="container mt-4">
  <h1 class="mb-4">My Medications</h1>

  <!-- Tab navigation -->
  <ul class="nav nav-tabs mb-4" id="medicationTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button
        class="nav-link active"
        id="manage-tab"
        data-bs-toggle="tab"
        data-bs-target="#manage"
        type="button"
        role="tab"
        aria-controls="manage"
        aria-selected="true"
      >
        Manage Medications
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button
        class="nav-link"
        id="track-tab"
        data-bs-toggle="tab"
        data-bs-target="#track"
        type="button"
        role="tab"
        aria-controls="track"
        aria-selected="false"
      >
        Medication Tracking
      </button>
    </li>
  </ul>

  <!-- Tab content -->
  <div class="tab-content" id="medicationTabsContent">
    <!-- Manage Medications Tab -->
    <div
      class="tab-pane fade show active"
      id="manage"
      role="tabpanel"
      aria-labelledby="manage-tab"
    >
      <div class="d-flex justify-content-between mb-3">
        <h2>My Medications</h2>
        <button
          type="button"
          class="btn btn-primary"
          data-bs-toggle="modal"
          data-bs-target="#addMedicationModal"
        >
          Add New Medication
        </button>
      </div>

      {% if medications %}
      <div class="table-responsive">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Name</th>
              <th>Description</th>
              <th>Frequency</th>
              <th>Tablets per Dose</th>
              <th>Refill Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for medication in medications %}
            <tr>
              <td>{{ medication.name }}</td>
              <td>{{ medication.description|truncatechars:50 }}</td>
              <td>{{ medication.frequency_per_day }} time(s) daily</td>
              <td>{{ medication.tablets_per_dose }}</td>
              <td>
                {% if medication.refill_date %} {{ medication.refill_date }} {%
                else %} Not set {% endif %}
              </td>
              <td>
                <div class="btn-group">
                  <a
                    href="{% url 'edit_medication' medication.id %}"
                    class="btn btn-sm btn-outline-primary"
                    >Edit</a
                  >
                  <a
                    href="{% url 'delete_medication' medication.id %}"
                    class="btn btn-sm btn-outline-danger"
                    >Delete</a
                  >
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="alert alert-info">
        You haven't added any medications yet. Click the "Add New Medication"
        button to get started.
      </div>
      {% endif %}
    </div>

    <!-- Medication Tracking Tab -->
    <div
      class="tab-pane fade"
      id="track"
      role="tabpanel"
      aria-labelledby="track-tab"
    >
      <div class="d-flex justify-content-between mb-3">
        <h2>Today's Medications</h2>
        <button id="resetTrackingBtn" class="btn btn-warning">
          Reset Today's Tracking
        </button>
      </div>

      <div class="date-display mb-3">
        <strong>Today: </strong
        ><span id="todayDate">{{ today|date:"F j, Y" }}</span>
      </div>

      {% if medications %}
      <div class="row">
        {% for medication in medications %}
        <div class="col-md-6 mb-4">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">{{ medication.name }}</h5>
            </div>
            <div class="card-body">
              <p>{{ medication.tablets_per_dose }} tablet(s) per dose</p>
              <div class="medication-doses">
                {% for dose_number in "x"|ljust:medication.frequency_per_day %}
                <div class="form-check form-check-inline">
                  <input
                    class="form-check-input dose-checkbox"
                    type="checkbox"
                    data-tracking-id="{{ medication.today_tracking.id }}"
                    data-dose-index="{{ forloop.counter0 }}"
                    id="dose-{{ medication.id }}-{{ forloop.counter0 }}"
                    {%
                    if
                    medication.today_tracking.doses_taken.forloop.counter0
                    %}checked{%
                    endif
                    %}
                  />
                  <label
                    class="form-check-label"
                    for="dose-{{ medication.id }}-{{ forloop.counter0 }}"
                  >
                    Dose {{ forloop.counter }}
                  </label>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="alert alert-info">
        You haven't added any medications yet. Go to the "Manage Medications"
        tab to add some.
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Add Medication Modal -->
<div
  class="modal fade"
  id="addMedicationModal"
  tabindex="-1"
  aria-labelledby="addMedicationModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addMedicationModalLabel">
          Add New Medication
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <form method="post" action="{% url 'add_medication' %}">
        <div class="modal-body">
          {% csrf_token %}
          <div class="mb-3">
            <label for="{{ form.name.id_for_label }}" class="form-label"
              >Name</label
            >
            {{ form.name }}
          </div>
          <div class="mb-3">
            <label for="{{ form.description.id_for_label }}" class="form-label"
              >Description</label
            >
            {{ form.description }}
          </div>
          <div class="mb-3">
            <label for="{{ form.refill_date.id_for_label }}" class="form-label"
              >Refill Date</label
            >
            {{ form.refill_date }}
          </div>
          <div class="mb-3">
            <label
              for="{{ form.frequency_per_day.id_for_label }}"
              class="form-label"
              >Times per Day</label
            >
            {{ form.frequency_per_day }}
          </div>
          <div class="mb-3">
            <label
              for="{{ form.tablets_per_dose.id_for_label }}"
              class="form-label"
              >Tablets per Dose</label
            >
            {{ form.tablets_per_dose }}
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">Save Medication</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %} {% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Display today's date
    const today = new Date();
    document.getElementById("todayDate").textContent = today.toLocaleDateString(
      "en-US",
      {
        year: "numeric",
        month: "long",
        day: "numeric",
      }
    );

    // Handle dose checkbox clicks
    document.querySelectorAll(".dose-checkbox").forEach((checkbox) => {
      checkbox.addEventListener("change", function () {
        const trackingId = this.dataset.trackingId;
        const doseIndex = this.dataset.doseIndex;

        fetch(`/medications/toggle-dose/${trackingId}/${doseIndex}/`, {
          method: "POST",
          headers: {
            "X-CSRFToken": getCookie("csrftoken"),
            "Content-Type": "application/json",
          },
          body: JSON.stringify({}),
        })
          .then((response) => response.json())
          .then((data) => {
            if (!data.success) {
              // Revert the checkbox if there was an error
              this.checked = !this.checked;
              alert("Failed to update medication tracking");
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            // Revert the checkbox
            this.checked = !this.checked;
            alert("Failed to update medication tracking");
          });
      });
    });

    // Handle reset tracking button
    document
      .getElementById("resetTrackingBtn")
      .addEventListener("click", function () {
        if (
          confirm(
            "Are you sure you want to reset all medication tracking for today?"
          )
        ) {
          fetch("/medications/reset-tracking/", {
            method: "POST",
            headers: {
              "X-CSRFToken": getCookie("csrftoken"),
              "Content-Type": "application/json",
            },
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                // Uncheck all checkboxes
                document
                  .querySelectorAll(".dose-checkbox")
                  .forEach((checkbox) => {
                    checkbox.checked = false;
                  });
                alert("Tracking has been reset successfully");
              } else {
                alert("Failed to reset tracking");
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              alert("Failed to reset tracking");
            });
        }
      });

    // Function to get CSRF token from cookies
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === name + "=") {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  });
</script>
{% endblock %}
