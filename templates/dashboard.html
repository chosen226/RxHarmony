<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Medication Manager</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .tab-content {
        margin-top: 20px;
      }
      .medication-card {
        margin-bottom: 15px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .medication-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .checkbox-container {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }
      .check-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 10px;
        min-width: 80px;
      }
      .check-item input {
        width: 20px;
        height: 20px;
      }
      .check-item label {
        margin-top: 5px;
        font-size: 12px;
      }
      .add-medication-form {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <h1 class="mb-4">Medication Manager</h1>

      <!-- Tabs -->
      <ul class="nav nav-tabs" id="medicationTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="manage-tab"
            data-bs-toggle="tab"
            data-bs-target="#manage"
            type="button"
            role="tab"
            aria-controls="manage"
            aria-selected="true"
          >
            Manage Medications
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="daily-tab"
            data-bs-toggle="tab"
            data-bs-target="#daily"
            type="button"
            role="tab"
            aria-controls="daily"
            aria-selected="false"
          >
            Daily Tracking
          </button>
        </li>
      </ul>

      <!-- Tab Content -->
      <div class="tab-content" id="medicationTabsContent">
        <!-- Manage Medications Tab -->
        <div
          class="tab-pane fade show active"
          id="manage"
          role="tabpanel"
          aria-labelledby="manage-tab"
        >
          <div class="add-medication-form">
            <h3>Add New Medication</h3>
            <form id="addMedicationForm">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="medName" class="form-label"
                    >Medication Name</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="medName"
                    required
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label for="refillDate" class="form-label">Refill Date</label>
                  <input type="date" class="form-control" id="refillDate" />
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="frequency" class="form-label"
                    >Frequency Per Day</label
                  >
                  <input
                    type="number"
                    class="form-control"
                    id="frequency"
                    min="1"
                    value="1"
                    required
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label for="tablets" class="form-label"
                    >Tablets Per Dose</label
                  >
                  <input
                    type="number"
                    class="form-control"
                    id="tablets"
                    min="1"
                    value="1"
                    required
                  />
                </div>
              </div>
              <div class="mb-3">
                <label for="description" class="form-label"
                  >Description/Notes</label
                >
                <textarea
                  class="form-control"
                  id="description"
                  rows="3"
                ></textarea>
              </div>
              <button type="submit" class="btn btn-primary">
                Add Medication
              </button>
            </form>
          </div>

          <h3>Your Medications</h3>
          <div id="medicationsList">
            <!-- Medications will be displayed here -->
          </div>
        </div>

        <!-- Daily Tracking Tab -->
        <div
          class="tab-pane fade"
          id="daily"
          role="tabpanel"
          aria-labelledby="daily-tab"
        >
          <h3>Today's Medications</h3>
          <div class="row">
            <div class="col-md-8">
              <div class="input-group mb-3">
                <span class="input-group-text">Date</span>
                <input type="date" class="form-control" id="trackingDate" />
              </div>
            </div>
            <div class="col-md-4">
              <button class="btn btn-success w-100" id="saveTracking">
                Save Tracking
              </button>
            </div>
          </div>
          <div id="dailyTrackingList">
            <!-- Daily tracking will be displayed here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Medication Item Template (Hidden) -->
    <template id="medicationItemTemplate">
      <div class="card medication-card mb-3">
        <div class="card-body">
          <div class="medication-header">
            <h5 class="medication-name card-title"></h5>
            <div>
              <button class="btn btn-sm btn-outline-primary edit-med">
                Edit
              </button>
              <button class="btn btn-sm btn-outline-danger delete-med">
                Delete
              </button>
            </div>
          </div>
          <div class="medication-details">
            <p class="card-text description"></p>
            <div class="row">
              <div class="col-md-4">
                <strong>Refill Date:</strong> <span class="refill-date"></span>
              </div>
              <div class="col-md-4">
                <strong>Frequency:</strong>
                <span class="frequency"></span> times/day
              </div>
              <div class="col-md-4">
                <strong>Tablets:</strong> <span class="tablets"></span> per dose
              </div>
            </div>
          </div>
          <div class="medication-form d-none">
            <form class="edit-medication-form">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Medication Name</label>
                  <input type="text" class="form-control edit-name" required />
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Refill Date</label>
                  <input type="date" class="form-control edit-refill" />
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Frequency Per Day</label>
                  <input
                    type="number"
                    class="form-control edit-frequency"
                    min="1"
                    required
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Tablets Per Dose</label>
                  <input
                    type="number"
                    class="form-control edit-tablets"
                    min="1"
                    required
                  />
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Description/Notes</label>
                <textarea
                  class="form-control edit-description"
                  rows="2"
                ></textarea>
              </div>
              <div>
                <button type="submit" class="btn btn-primary save-changes">
                  Save
                </button>
                <button type="button" class="btn btn-secondary cancel-edit">
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </template>

    <!-- Daily Tracking Template (Hidden) -->
    <template id="dailyTrackingTemplate">
      <div class="card medication-card mb-3">
        <div class="card-body">
          <h5 class="card-title tracking-name"></h5>
          <div class="row mb-2">
            <div class="col-md-6">
              <span class="badge bg-info">
                <span class="tracking-tablets"></span> tablets per dose
              </span>
            </div>
          </div>
          <div class="checkbox-container">
            <!-- Checkboxes will be added dynamically -->
          </div>
        </div>
      </div>
    </template>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
      let trackingData = {};
      let medications = []; // This will be populated via AJAX

      // Set today's date as default
      document.addEventListener("DOMContentLoaded", function () {
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("trackingDate").value = today;

        // Fetch medications from the server
        fetchMedications();

        // Add event listeners
        document
          .getElementById("addMedicationForm")
          .addEventListener("submit", addMedication);
        document
          .getElementById("trackingDate")
          .addEventListener("change", loadDailyTracking);
        document
          .getElementById("saveTracking")
          .addEventListener("click", saveTracking);
      });

      // Fetch medications from the server
      function fetchMedications() {
        fetch("/api/medications/")
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            medications = data;
            loadMedications();
            loadDailyTracking();
          })
          .catch((error) => {
            console.error("Error fetching medications:", error);
            document.getElementById(
              "medicationsList"
            ).innerHTML = `<div class="alert alert-danger">Error loading medications: ${error.message}</div>`;
          });
      }

      // Load medications into the manage tab
      function loadMedications() {
        const medicationsList = document.getElementById("medicationsList");
        medicationsList.innerHTML = "";

        if (medications.length === 0) {
          medicationsList.innerHTML = "<p>No medications added yet.</p>";
          return;
        }

        medications.forEach((med) => {
          const template = document.getElementById("medicationItemTemplate");
          const clone = template.content.cloneNode(true);

          clone.querySelector(".medication-name").textContent = med.name;
          clone.querySelector(".description").textContent =
            med.description || "No description";
          clone.querySelector(".refill-date").textContent =
            med.refill_date || "Not set";
          clone.querySelector(".frequency").textContent = med.frequency_per_day;
          clone.querySelector(".tablets").textContent = med.tablets_per_dose;

          // Set form fields for editing
          clone.querySelector(".edit-name").value = med.name;
          clone.querySelector(".edit-refill").value = med.refill_date || "";
          clone.querySelector(".edit-frequency").value = med.frequency_per_day;
          clone.querySelector(".edit-tablets").value = med.tablets_per_dose;
          clone.querySelector(".edit-description").value =
            med.description || "";

          // Set data attribute for medication ID
          const card = clone.querySelector(".medication-card");
          card.dataset.id = med.id;

          // Add event listeners for edit/delete
          card
            .querySelector(".edit-med")
            .addEventListener("click", function () {
              toggleEditMode(card);
            });

          card
            .querySelector(".delete-med")
            .addEventListener("click", function () {
              deleteMedication(med.id);
            });

          card
            .querySelector(".cancel-edit")
            .addEventListener("click", function () {
              toggleEditMode(card);
            });

          card
            .querySelector(".edit-medication-form")
            .addEventListener("submit", function (e) {
              e.preventDefault();
              saveMedicationChanges(card);
            });

          medicationsList.appendChild(clone);
        });
      }

      // Load daily tracking tab
      function loadDailyTracking() {
        const dailyList = document.getElementById("dailyTrackingList");
        dailyList.innerHTML = "";

        if (medications.length === 0) {
          dailyList.innerHTML = "<p>No medications to track.</p>";
          return;
        }

        const selectedDate = document.getElementById("trackingDate").value;

        // Fetch tracking data for the selected date if available
        fetchTrackingData(selectedDate)
          .then(() => {
            // Initialize tracking data for this date if it doesn't exist
            if (!trackingData[selectedDate]) {
              trackingData[selectedDate] = {};
              medications.forEach((med) => {
                trackingData[selectedDate][med.id] = Array(
                  med.frequency_per_day
                ).fill(false);
              });
            }

            medications.forEach((med) => {
              const template = document.getElementById("dailyTrackingTemplate");
              const clone = template.content.cloneNode(true);

              clone.querySelector(".tracking-name").textContent = med.name;
              clone.querySelector(".tracking-tablets").textContent =
                med.tablets_per_dose;

              const card = clone.querySelector(".medication-card");
              card.dataset.id = med.id;

              const checkboxContainer = clone.querySelector(
                ".checkbox-container"
              );

              // Create checkboxes based on frequency
              for (let i = 0; i < med.frequency_per_day; i++) {
                const checkItem = document.createElement("div");
                checkItem.className = "check-item";

                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.id = `med-${med.id}-dose-${i}`;
                checkbox.checked = trackingData[selectedDate][med.id][i];
                checkbox.addEventListener("change", function () {
                  trackingData[selectedDate][med.id][i] = this.checked;
                });

                const label = document.createElement("label");
                label.htmlFor = `med-${med.id}-dose-${i}`;
                label.textContent = getDoseLabel(i);

                checkItem.appendChild(checkbox);
                checkItem.appendChild(label);
                checkboxContainer.appendChild(checkItem);
              }

              dailyList.appendChild(clone);
            });
          })
          .catch((error) => {
            console.error("Error loading tracking data:", error);
            dailyList.innerHTML = `<div class="alert alert-danger">Error loading tracking data: ${error.message}</div>`;
          });
      }

      // Fetch tracking data for a specific date
      function fetchTrackingData(date) {
        return fetch(`/api/tracking/${date}/`)
          .then((response) => {
            if (!response.ok) {
              // If 404, it just means no data yet for this date, which is fine
              if (response.status === 404) {
                return { tracking: {} };
              }
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            if (data && data.tracking) {
              trackingData[date] = data.tracking;
            }
          })
          .catch((error) => {
            // Just log the error and continue with empty tracking data
            console.error("Error fetching tracking data:", error);
            trackingData[date] = {};
            medications.forEach((med) => {
              trackingData[date][med.id] = Array(med.frequency_per_day).fill(
                false
              );
            });
          });
      }

      // Helper function to get dose label
      function getDoseLabel(index) {
        const labels = ["Morning", "Noon", "Evening", "Night"];
        return index < labels.length ? labels[index] : `Dose ${index + 1}`;
      }

      // Add a new medication
      function addMedication(e) {
        e.preventDefault();

        const newMed = {
          name: document.getElementById("medName").value,
          description: document.getElementById("description").value,
          refill_date: document.getElementById("refillDate").value,
          frequency_per_day: parseInt(
            document.getElementById("frequency").value
          ),
          tablets_per_dose: parseFloat(
            document.getElementById("tablets").value
          ),
        };

        // Send the new medication to the server
        fetch("/api/medications/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCsrfToken(), // Function to get CSRF token (defined below)
          },
          body: JSON.stringify(newMed),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            // Reset form
            document.getElementById("addMedicationForm").reset();

            // Refresh medications list
            fetchMedications();
          })
          .catch((error) => {
            console.error("Error adding medication:", error);
            alert(`Error adding medication: ${error.message}`);
          });
      }

      // Toggle edit mode for a medication
      function toggleEditMode(card) {
        const detailsDiv = card.querySelector(".medication-details");
        const formDiv = card.querySelector(".medication-form");

        detailsDiv.classList.toggle("d-none");
        formDiv.classList.toggle("d-none");
      }

      // Save changes to a medication
      function saveMedicationChanges(card) {
        const medId = parseInt(card.dataset.id);

        const updatedMed = {
          id: medId,
          name: card.querySelector(".edit-name").value,
          description: card.querySelector(".edit-description").value,
          refill_date: card.querySelector(".edit-refill").value,
          frequency_per_day: parseInt(
            card.querySelector(".edit-frequency").value
          ),
          tablets_per_dose: parseFloat(
            card.querySelector(".edit-tablets").value
          ),
        };

        // Send the updated medication to the server
        fetch(`/api/medications/${medId}/`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCsrfToken(),
          },
          body: JSON.stringify(updatedMed),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            // After successful update, refresh the medications
            fetchMedications();
            toggleEditMode(card);
          })
          .catch((error) => {
            console.error("Error updating medication:", error);
            alert(`Error updating medication: ${error.message}`);
          });
      }

      // Delete a medication
      function deleteMedication(medId) {
        if (confirm("Are you sure you want to delete this medication?")) {
          fetch(`/api/medications/${medId}/`, {
            method: "DELETE",
            headers: {
              "X-CSRFToken": getCsrfToken(),
            },
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error("Network response was not ok");
              }
              // After successful deletion, refresh the medications
              fetchMedications();
            })
            .catch((error) => {
              console.error("Error deleting medication:", error);
              alert(`Error deleting medication: ${error.message}`);
            });
        }
      }

      // Save tracking data
      function saveTracking() {
        const selectedDate = document.getElementById("trackingDate").value;

        fetch(`/api/tracking/${selectedDate}/`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCsrfToken(),
          },
          body: JSON.stringify({
            tracking: trackingData[selectedDate],
          }),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            alert("Tracking data saved successfully!");
          })
          .catch((error) => {
            console.error("Error saving tracking data:", error);
            alert(`Error saving tracking data: ${error.message}`);
          });
      }

      // Helper function to get CSRF token from cookies
      function getCsrfToken() {
        const cookieValue = document.cookie
          .split("; ")
          .find((row) => row.startsWith("csrftoken="));

        if (cookieValue) {
          return cookieValue.split("=")[1];
        }

        // If no CSRF token in cookies, look for it in a meta tag
        const csrfInput = document.querySelector('meta[name="csrf-token"]');
        if (csrfInput) {
          return csrfInput.getAttribute("content");
        }

        return "";
      }
    </script>
  </body>
</html>
